<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IIIT-H Technology Portfolio</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "sf9jz6kg3u");
    </script>
    <style>
        /* Poppins Font Import */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        :root {
            --primary-color: #2A9D8F; /* Teal */
            --secondary-color: #264653; /* Dark Slate Gray */
            --accent-color-1: #E9C46A; /* Saffron */
            --accent-color-2: #F4A261; /* Sandy Brown */
            --light-bg: #f8f9fa;
            --dark-text: #343a40;
            --light-text: #ffffff;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-text);
        }

        .navbar {
            background-color: var(--secondary-color);
            box-shadow: 0 2px 8px rgba(0,0,0,.15);
        }
        .navbar-brand, .nav-link {
            color: var(--light-text) !important;
            font-weight: 500;
        }
        .nav-link.active, .nav-link:hover {
            color: var(--accent-color-1) !important;
        }
        .content-section {
            padding-top: 80px;
            min-height: calc(100vh - 70px);
        }
        .card {
            border: 1px solid #dee2e6;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,.05);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            height: 100%;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,.1);
        }
        .card-title {
            color: var(--primary-color);
            font-weight: 600;
        }
        .badge {
            border-radius: 8px;
            padding: 0.4em 0.8em;
            font-weight: 500;
            margin-right: 5px;
            margin-bottom: 5px;
            display: inline-block;
            background-color: transparent; /* No background color for outline effect */
            border: 1px solid; /* Add border for outline */
        }
        /* Badge Colors for outlines - using darker shades */
        .badge-outline-1 { border-color: #004D40; color: #004D40; } /* Dark Green */
        .badge-outline-2 { border-color: #1A237E; color: #1A237E; } /* Dark Blue */
        .badge-outline-3 { border-color: #311B92; color: #311B92; } /* Dark Purple */
        .badge-outline-4 { border-color: #B71C1C; color: #B71C1C; } /* Dark Red */
        .badge-outline-5 { border-color: #4E342E; color: #4E342E; } /* Dark Brown */
        .badge-outline-6 { border-color: #006064; color: #006064; } /* Dark Cyan */
        .badge-outline-7 { border-color: #212121; color: #212121; } /* Very Dark Grey */
        .badge-outline-8 { border-color: #424242; color: #424242; } /* Dark Grey */
        .badge-outline-9 { border-color: #616161; color: #616161; } /* Medium Dark Grey */
        .badge-outline-10 { border-color: #D32F2F; color: #D32F2F; } /* Slightly brighter dark red */


        .filter-sidebar {
            background-color: var(--light-text);
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,.05);
            padding: 20px;
            margin-bottom: 20px;
            position: sticky;
            top: 80px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }
        .filter-title {
            color: var(--secondary-color);
            font-weight: 600;
            margin-bottom: 15px;
        }
        .form-check-label {
            cursor: pointer;
        }
        .chart-container {
            position: relative;
            margin-bottom: 20px;
        }
        .chart-card {
            height: 100%;
        }
        .modal-content {
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,.15);
        }
        .modal-header {
            background-color: var(--secondary-color);
            color: var(--light-text);
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }
        .modal-title {
            font-weight: 600;
        }
        .modal-body h5, .modal-body h6 {
            color: var(--primary-color);
            font-weight: 600;
            margin-top: 15px;
            margin-bottom: 10px;
        }
        .modal-body ul {
            list-style-type: none;
            padding-left: 0;
        }
        .modal-body ul li {
            margin-bottom: 5px;
        }
        .tag-cloud-item {
            display: inline-block;
            background-color: transparent; /* No background color */
            padding: 8px 12px;
            border-radius: 20px;
            margin: 5px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s; /* Added border-color to transition */
            border: 1px solid; /* For outline effect */
        }
        .tag-cloud-item:hover {
            background-color: var(--accent-color-2);
            color: white;
            border-color: var(--accent-color-2); /* Change border color on hover */
        }
        .tag-cloud-item.selected {
            background-color: var(--primary-color); /* Highlight selected items */
            color: var(--light-text);
            border-color: var(--primary-color);
        }
        .search-results-section {
            padding: 20px;
            background-color: var(--light-text);
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,.05);
            margin-top: 20px;
        }
        .search-results-title {
            color: var(--secondary-color);
            font-weight: 600;
            margin-bottom: 15px;
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .btn-primary:hover {
            background-color: #248a7e; /* Slightly darker teal */
            border-color: #248a7e;
        }
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: var(--light-text);
        }
        .text-primary {
            color: var(--primary-color) !important;
        }
        /* Specific badge colors for "Patent" and "Publication" labels */
        .badge.bg-primary { /* For Patent type badge */
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
            color: white !important;
        }
        .badge.bg-info { /* For Publication type badge */
            background-color: var(--accent-color-1) !important;
            border-color: var(--accent-color-1) !important;
            color: var(--dark-text) !important; /* Ensure text is readable on light accent */
        }
        .badge.bg-success { /* For Market Potential Summary in cards */
            background-color: var(--accent-color-2) !important;
            border-color: var(--accent-color-2) !important;
        }
        .badge.bg-warning { /* For Innovation Level Summary in cards */
            background-color: var(--accent-color-1) !important;
            border-color: var(--accent-color-1) !important;
            color: var(--dark-text) !important;
        }

        /* New styles for scrollable clouds and "More" button */
        .cloud-container {
            max-height: 180px; /* Fixed initial height */
            overflow-y: auto; /* Always enable scrolling */
            padding-bottom: 10px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            background-color: #fcfcfc;
        }
        /* Removed .expanded class as it's no longer needed */
        .toggle-cloud-btn {
            display: none; /* Hide the toggle buttons */
        }

        /* Styles for chart canvases to ensure responsiveness */
        .chart-canvas {
            width: 100% !important;
            height: 250px !important; /* Fixed height for charts to prevent scrolling */
        }

        /* Filter dropdown */
        .filter-dropdown .dropdown-menu {
            max-height: 300px;
            overflow-y: auto;
            width: 100%;
        }
        .filter-dropdown .dropdown-toggle {
            width: 100%;
        }
        /* Style for chart containers to hold two canvases side-by-side */
        .chart-pair-container {
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            gap: 10px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        .chart-pair-container > div {
            flex: 1;
            min-width: 200px; /* Minimum width for each chart */
            max-width: 48%; /* Max width to allow two per row */
        }
        
        /* Strategic Insights Styles */
        .heatmap-container {
            overflow-x: auto;
            padding: 1px;
            border-radius: 0.75rem;
            box-shadow: 0 4px 8px rgba(0,0,0,.05);
            background-color: #ffffff;
            margin-top: 2rem;
            margin-bottom: 2rem; /* Add margin at the bottom */
            overflow-y: auto; /* Added for vertical scrolling within heatmap container */
            max-height: 600px; /* Example max height for heatmap container */
        }
        .heatmap-container table {
            border-collapse: collapse;
            width: 100%;
            white-space: nowrap;
        }
        .heatmap-container th, .heatmap-container td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem 1rem;
            text-align: left;
        }
        .heatmap-container th {
            background-color: #f0f4f7; /* Lighter background for headers */
            font-weight: 600;
            font-size: 0.85rem; /* Slightly larger font */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            z-index: 10;
            color: var(--secondary-color); /* Darker text for headers */
        }
        .heatmap-container td.row-header {
            font-weight: 500;
            background-color: #f0f4f7; /* Lighter background for row headers */
            position: sticky;
            left: 0;
            border-right: 2px solid #e5e7eb;
            color: var(--dark-text);
        }
        .heatmap-container .value-cell {
            text-align: center;
            font-weight: 600;
            font-size: 1rem;
            color: rgba(0,0,0,0.7);
            min-width: 80px;
            transition: background-color 0.3s ease; /* Smooth transition for color changes */
        }
        .heatmap-container .value-cell.dark-text {
            color: rgba(255,255,255,0.95);
        }
        .detail-item-property {
            margin-bottom: 0.5rem;
        }
        .detail-item-property strong {
            color: var(--primary-color);
        }
        /* Styles for separating sections on detail pages */
        .detail-section-separator {
            margin-top: 2rem;
            margin-bottom: 2rem;
            padding-top: 1.5rem;
            padding-bottom: 1.5rem;
            background-color: #f0f4f7; /* Light grey background */
            border-radius: 10px;
            border: 1px solid #e0e6eb;
        }
        .detail-section-separator:nth-child(even) {
            background-color: #e9eff3; /* Slightly different shade for alternating sections */
        }
        .detail-section-separator h6 {
            color: var(--secondary-color);
            font-weight: 700;
            margin-bottom: 1rem;
            text-align: center;
        }
        .badge-group {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
            margin-bottom: 15px;
        }

        /* Specific styling for list-tile like cards (single column) */
        .list-tile-card .card-body {
            display: flex;
            flex-direction: column;
        }
        .list-tile-card .card-text {
            margin-bottom: 0.25rem; /* Reduce space between text lines */
        }
        .list-tile-card .badge-group {
            margin-top: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .list-tile-card .btn {
            align-self: flex-start; /* Align button to the start */
        }

        /* Sidebar navigation styling */
        .filter-sidebar .list-group-item {
            border-left: 4px solid transparent;
            transition: all 0.2s ease-in-out;
            margin-bottom: 5px; /* Add some space between items */
            border-radius: 8px; /* Rounded corners for list items */
        }
        .filter-sidebar .list-group-item.active {
            border-left-color: var(--primary-color);
            background-color: var(--primary-color);
            color: var(--light-text);
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .filter-sidebar .list-group-item:hover:not(.active) {
            background-color: rgba(42, 157, 143, 0.1); /* Light primary color background on hover */
            border-left-color: var(--primary-color);
            color: var(--primary-color);
        }
        .filter-sidebar .list-group-item.active:hover {
            color: var(--light-text); /* Keep text white on hover for active item */
        }

        /* Table styling for dashboard lists */
        .dashboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: white;
            border-radius: 10px;
            overflow: hidden; /* Ensures rounded corners apply to table content */
            box-shadow: 0 4px 8px rgba(0,0,0,.05);
        }
        .dashboard-table th, .dashboard-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: top;
            font-size: 0.85em; /* Reduced font size */
        }
        .dashboard-table th {
            background-color: var(--secondary-color);
            color: var(--light-text);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
        }
        .dashboard-table tbody tr {
            cursor: pointer; /* Make rows clickable */
            transition: background-color 0.2s ease-in-out;
        }
        .dashboard-table tbody tr:hover {
            background-color: #f5f5f5;
        }
        .dashboard-table td {
            max-height: 3.5em; /* Limit height for 2-3 lines of text */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal; /* Allow text to wrap */
            line-height: 1.2em; /* Adjust line height */
        }

        /* About Page Specific Styles (now integrated into Dashboard) */
        .integrated-about-section {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,.05);
            padding: 30px;
            margin-top: 30px;
            margin-bottom: 30px;
        }
        .integrated-about-section h3 {
            color: var(--secondary-color);
            font-weight: 600;
            margin-bottom: 20px;
        }
        .integrated-about-section h4 {
            color: var(--primary-color);
            font-weight: 500;
            margin-top: 25px;
            margin-bottom: 15px;
        }
        .integrated-about-section p {
            line-height: 1.6;
            margin-bottom: 15px;
        }
        .integrated-about-section ul {
            list-style-type: disc;
            padding-left: 25px;
            margin-bottom: 20px;
        }
        .integrated-about-section ul li {
            margin-bottom: 8px;
        }

        /* Styles for number tiles */
        .number-tile-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
            margin-bottom: 30px; /* Added margin-bottom */
        }
        .number-tile {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            padding: 15px;
            text-align: center;
            flex: 1 1 calc(25% - 15px); /* Four tiles per row, adjust for gap */
            min-width: 150px; /* Minimum width for responsiveness */
            max-width: 25%;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .number-tile:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .number-tile h6 {
            color: var(--secondary-color);
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        .number-tile .count {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        /* Responsive adjustments for number tiles */
        @media (max-width: 992px) {
            .number-tile {
                flex: 1 1 calc(33.33% - 15px); /* Three tiles per row on medium screens */
                max-width: 33.33%;
            }
        }
        @media (max-width: 768px) {
            .number-tile {
                flex: 1 1 calc(50% - 15px); /* Two tiles per row on small screens */
                max-width: 50%;
            }
        }
        @media (max-width: 576px) {
            .number-tile {
                flex: 1 1 100%; /* One tile per row on extra small screens */
                max-width: 100%;
            }
        }

        /* Dashboard View Toggles (now tabs) */
        .dashboard-tabs .nav-link {
            padding: 12px 20px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 10px 10px 0 0; /* Rounded top corners */
            color: var(--secondary-color);
            border: 1px solid var(--secondary-color);
            border-bottom: none; /* No bottom border for tabs */
            margin-right: 5px; /* Space between tabs */
            background-color: #e9ecef; /* Light background for inactive tabs */
            transition: all 0.2s ease-in-out;
        }
        .dashboard-tabs .nav-link.active {
            background-color: var(--primary-color);
            color: var(--light-text);
            border-color: var(--primary-color);
            border-bottom-color: var(--primary-color); /* Active tab has a bottom border matching its color */
        }
        .dashboard-tabs .nav-link:hover:not(.active) {
            background-color: rgba(42, 157, 143, 0.1); /* Light primary color background on hover */
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .dashboard-tab-content {
            border: 1px solid var(--primary-color);
            border-top: none; /* No top border as it connects to active tab */
            padding: 20px;
            border-radius: 0 0 10px 10px; /* Rounded bottom corners */
            background-color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,.05);
        }

        /* Market View Search Bar Specific Styles */
        .market-view-search-bar-section {
            background-color: var(--secondary-color);
            padding: 30px 0;
            margin-bottom: 30px;
            text-align: center;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,.1);
        }
        .market-view-search-input-group {
            max-width: 700px;
            margin: 0 auto;
            position: relative; /* Added for suggestions positioning */
        }
        .market-view-search-input {
            border-top-left-radius: 25px !important;
            border-bottom-left-radius: 25px !important;
            border-right: none;
            padding: 12px 20px;
            font-size: 1.1rem;
            border: 1px solid var(--primary-color);
        }
        .market-view-search-input:focus {
            box-shadow: 0 0 0 0.25rem rgba(42, 157, 143, 0.25);
            border-color: var(--primary-color);
        }
        .market-view-search-dropdown-toggle {
            border-top-right-radius: 25px !important;
            border-bottom-right-radius: 25px !important;
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: var(--light-text);
            padding: 12px 15px;
            font-size: 1.1rem;
        }
        .market-view-search-dropdown-toggle:hover {
            background-color: #248a7e;
            border-color: #248a7e;
        }
        .market-view-search-dropdown-menu {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,.1);
        }
        .market-view-search-suggestions {
            position: absolute;
            width: calc(100% - 130px); /* Adjust width based on dropdown button */
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #ced4da;
            border-top: none;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            z-index: 1000;
            left: 0; /* Align with input */
        }
        .market-view-search-suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            text-align: left;
        }
        .market-view-search-suggestion-item:hover {
            background-color: #e9ecef;
        }

        /* New styles for row/column header clickability */
        .heatmap-container th.clickable-header {
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .heatmap-container th.clickable-header:hover {
            background-color: #dbe4eb; /* Lighter hover for header */
        }
        /* Removed clickable-cell as per request */
        /* .heatmap-container td.clickable-cell {
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .heatmap-container td.clickable-cell:hover {
            filter: brightness(0.9);
        } */

        /* Styles for the new single metric tiles */
        .single-metric-tile {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            padding: 20px;
            text-align: left;
            margin-bottom: 20px;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .single-metric-tile:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .single-metric-tile h5 {
            color: var(--secondary-color);
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .single-metric-tile h5 i {
            margin-right: 10px;
            color: var(--primary-color);
        }
        .single-metric-tile ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .single-metric-tile ul li {
            margin-bottom: 8px;
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .single-metric-tile ul li strong {
            color: var(--primary-color);
            font-weight: 500;
        }
        .single-metric-tile ul li span {
            font-weight: 600;
            color: var(--dark-text);
        }
        /* Added for percentage display */
        .single-metric-tile ul li .percentage {
            font-size: 0.85em;
            color: #6c757d; /* Muted color for percentage */
            margin-left: 5px;
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" onclick="showPage('dashboard')">IIIT-H Technology Portfolio</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('dashboard')">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('patents')">Patents Explorer</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('publications')">Publications Explorer</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('strategic-insights')">Strategic Insights</a>
                    </li>
                </ul>
                <form class="d-flex" onsubmit="handleGlobalSearch(event)">
                    <input class="form-control me-2 rounded-pill" type="search" placeholder="Global Search" aria-label="Search" id="globalSearchInput">
                    <button class="btn btn-outline-light rounded-pill" type="submit"><i class="fas fa-search"></i></button>
                </form>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <div class="container-fluid content-section">
        
        <!-- Dashboard Page Structure (Fixed for immediate DOM availability) -->
        <div id="dashboard-page" class="page-content" style="display:none;">
            <!-- Integrated About Section -->
            <div class="nav nav-tabs justify-content-center dashboard-tabs mb-3">
                <div class="col-lg-10 col-md-11">
                    <div class="integrated-about-section">
                        <h2 class="text-center" style="color: var(--secondary-color);">Welcome to the IIIT-H Technology Portfolio</h2>
                        <p class="lead text-center">Your comprehensive guide to the innovative research and intellectual property from IIIT Hyderabad.</p>

                        <h5>🔍 What You'll Find</h5>
                        <p>Explore cutting-edge technologies aligned with real-world market potential, TRLs, and trends. This platform offers:</p>
                        <ul>
                            <li><strong>Dashboard:</strong> A visual overview of key technology metrics and trends.</li>
                            <li><strong>Patents Explorer:</strong> Detailed insights into IIIT-H's patent portfolio with advanced filtering.</li>
                            <li><strong>Publications Explorer:</strong> Access to research papers, filterable by various criteria.</li>
                            <li><strong>Strategic Insights:</strong> Heatmaps illustrating technology alignment with industries, companies, social impact, and UN SDGs.</li>
                            <li><strong>Global Search:</strong> Quickly find relevant patents or publications by keyword, author, or topic.</li>
                        </ul>

                        <h4>How the Data is Organized</h4>
                        <p>Technologies are evaluated using four key measures:</p>
                        <ul>
                            <li><strong>Technology Trends:</strong> Assesses novelty and relevance (Visionary, Contemporary, Laggers).</li>
                            <li><strong>Market Potential:</strong> Measures commercial viability and strategic fit.</li>
                            <li><strong>Market Activity:</strong> Reflects funding, startups, and government support.</li>
                            <li><strong>TRL (Technology Readiness Level):</strong> Indicates maturity from research (TRL 0–2) to deployment (TRL 7–9).</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="row pt-4">
                <div class="col-12">
                    <ul class="nav nav-tabs justify-content-center dashboard-tabs mb-3" id="dashboardTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="technology-tab" data-bs-toggle="tab" data-bs-target="#technology-portfolio-view" type="button" role="tab" aria-controls="technology-portfolio-view" aria-selected="true" onclick="showDashboardView('technology')">Technology Portfolio View</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="market-tab" data-bs-toggle="tab" data-bs-target="#market-view" type="button" role="tab" aria-controls="market-view" aria-selected="false" onclick="showDashboardView('market')">Market View</button>
                        </li>
                    </ul>
                    <div class="tab-content dashboard-tab-content" id="dashboardTabContent">
                        <div class="tab-pane fade show active" id="technology-portfolio-view" role="tabpanel" aria-labelledby="technology-tab"></div>
                        <div class="tab-pane fade" id="market-view" role="tabpanel" aria-labelledby="market-tab"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="patents-page" class="page-content" style="display:none;"></div>
        <div id="publications-page" class="page-content" style="display:none;"></div>
        <div id="categories-insights-page" class="page-content"></div>
        
        <!-- Strategic Insights Page Structure (Modified for sidebar) -->
        <div id="strategic-insights-page" class="page-content" style="display:none;">
            <div class="row pt-4">
                <div class="col-md-3">
                    <div class="filter-sidebar">
                        <h5 class="filter-title">Strategic Insights Categories</h5>
                        <div class="list-group" id="strategic-nav">
                            <a href="#" class="list-group-item list-group-item-action active" onclick="renderStrategicHeatmap('industry', this)">Industry Sector Strength</a>
                            <a href="#" class="list-group-item list-group-item-action" onclick="renderStrategicHeatmap('company', this)">Company Alignment Strength</a>
                            <a href="#" class="list-group-item list-group-item-action" onclick="renderStrategicHeatmap('productwise', this)">Product Application Strength</a>
                            <a href="#" class="list-group-item list-group-item-action" onclick="renderStrategicHeatmap('social', this)">Social Impact & Govt Application Strength</a>
                            <a href="#" class="list-group-item list-group-item-action" onclick="renderStrategicHeatmap('sdg', this)">UN Sustainable Development Goal (SDG) Alignment</a>
                           <!--
                            <a href="#" class="list-group-item list-group-item-action" onclick="renderStrategicHeatmap('lm', this)">Learning Management</a>
                            -->
                        </div>
                    </div>
                </div>
                <div class="col-md-9">
                    <div id="strategic-content-area">
                        <!-- Heatmap content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <div id="productwise-detail-page" class="page-content" style="display:none;"></div>
        <div id="sdg-detail-page" class="page-content" style="display:none;"></div>
        <div id="social-detail-page" class="page-content" style="display:none;"></div>
        <div id="industry-detail-page" class="page-content" style="display:none;"></div>
        <div id="company-detail-page" class="page-content" style="display:none;"></div>
        <div id="lm-detail-page" class="page-content" style="display:none;"></div>
        <div id="search-results-page" class="page-content" style="display:none;"></div>
    </div>

    <!-- Modals for Details -->
    <!-- Patent Detail Modal -->
    <div class="modal fade" id="patentDetailModal" tabindex="-1" aria-labelledby="patentDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="patentDetailModalLabel">Patent Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Top Section -->
                    <h4 id="patentDetailTitle" class="mb-2"></h4>
                    <p class="text-muted mb-2">Inventors: <span id="patentDetailInventors"></span></p>
                    <div class="badge-group">
                        <span id="patentDetailTechTrendBadge"></span>
                        <span id="patentDetailMarketPotentialBadge"></span>
                        <span id="patentDetailMarketActivityBadge"></span>
                        <span id="patentDetailTRLBadge"></span>
                    </div>
                    <!-- Removed Abstract Glimpse and Use Case Glimpse -->

                    <!-- Clustered Metadata -->
                    <div class="card mb-3 detail-section-separator">
                        <div class="card-body">
                            <h6>Summary / Abstract</h6>
                            <p id="patentDetailSummary"></p>
                        </div>
                    </div>

                    <div class="card mb-3 detail-section-separator">
                        <div class="card-body">
                            <h6>Market Opportunity & Activity</h6>
                            <p><strong>Market Category:</strong> <span id="patentDetailMarketCat"></span></p>
                            <p><strong>Market Trend:</strong> <span id="patentDetailMarketTrend"></span></p>
                            <p><strong>Market Potential Summary:</strong> <span id="patentDetailMarketPotentialSummary"></span></p>
                            <p><strong>Market Activity:</strong> <span id="patentDetailMarketActivity"></span></p>
                        </div>
                    </div>

                    <div class="card mb-3 detail-section-separator">
                        <div class="card-body">
                            <h6>Technology Assessment</h6>
                            <p><strong>Problem:</strong> <span id="patentDetailProblem"></span></p>
                            <p><strong>Uniqueness:</strong> <span id="patentDetailUniqueness"></span></p>
                            <p><strong>Approach:</strong> <span id="patentDetailApproach"></span></p>
                            <p><strong>Tech Trend:</strong> <span id="patentDetailTechTrend"></span></p>
                            <p><strong>Innovation Level Summary:</strong> <span id="patentDetailInnovationLevelSummary"></span></p>
                            <p><strong>Depth of Technology Summary:</strong> <span id="patentDetailDepthOfTechnologySummary"></span></p>
                            <p><strong>Detailed Reasoning:</strong> <span id="patentDetailDetailedReasoning"></span></p>
                        </div>
                    </div>

                    <div class="card mb-3 detail-section-separator">
                        <div class="card-body">
                            <h6>Use Case Mapping</h6>
                            <div id="patentDetailUseCasesMapping"></div>
                        </div>
                    </div>

                    <div class="card detail-section-separator">
                        <div class="card-body">
                            <h6>Shortcomings & Risks</h6>
                            <p><strong>Shortcomings:</strong> <span id="patentDetailShortcomings"></span></p>
                            <p><strong>Risks:</strong> <span id="patentDetailRisks"></span></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="downloadPDF('patent')">Download PDF</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Publication Detail Modal -->
    <div class="modal fade" id="publicationDetailModal" tabindex="-1" aria-labelledby="publicationDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="publicationDetailModalLabel">Publication Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Top Section -->
                    <h4 id="publicationDetailTitle" class="mb-2"></h4>
                    <p class="text-muted mb-2">Authors: <span id="publicationDetailAuthors"></span></p>
                    <div class="badge-group">
                        <span id="publicationDetailTechTrendBadge"></span>
                        <span id="publicationDetailMarketPotentialBadge"></span>
                        <span id="publicationDetailMarketActivityBadge"></span>
                        <span id="publicationDetailTRLBadge"></span>
                    </div>
                    <!-- Removed Abstract Glimpse and Use Case Glimpse -->

                    <!-- Clustered Metadata -->
                    <div class="card mb-3 detail-section-separator">
                        <div class="card-body">
                            <h6>Summary / Abstract</h6>
                            <p id="publicationDetailSummary"></p>
                        </div>
                    </div>

                    <div class="card mb-3 detail-section-separator">
                        <div class="card-body">
                            <h6>Market Opportunity & Activity</h6>
                            <p><strong>Market Category:</strong> <span id="publicationDetailMarketCat"></span></p>
                            <p><strong>Market Trend:</strong> <span id="publicationDetailMarketTrend"></span></p>
                            <p><strong>Market Potential Technology Type:</strong> <span id="publicationDetailMarketPotentialType"></span></p>
                            <p><strong>Market Potential Category:</strong> <span id="publicationDetailMarketPotentialCategory"></span></p>
                            <p><strong>Market Activity Category:</strong> <span id="publicationDetailMarketActivityCategory"></span></p>
                        </div>
                    </div>

                    <div class="card mb-3 detail-section-separator">
                        <div class="card-body">
                            <h6>Technology Assessment</h6>
                            <p><strong>Problem:</strong> <span id="publicationDetailProblem"></span></p>
                            <p><strong>Uniqueness:</strong> <span id="publicationDetailUniqueness"></span></p>
                            <p><strong>Approach:</strong> <span id="publicationDetailApproach"></span></p>
                            <p><strong>Tech Trend:</strong> <span id="publicationDetailTechTrend"></span></p>
                            <p><strong>Technology Trends Classification:</strong> <span id="publicationDetailTechTrendClassification"></span></p>
                            <p><strong>Depth:</strong> <span id="publicationDetailDepth"></span></p>
                            <p><strong>Depth of Technology Category:</strong> <span id="publicationDetailDepthCategory"></span></p>
                        </div>
                    </div>

                    <div class="card mb-3 detail-section-separator">
                        <div class="card-body">
                            <h6>Use Cases</h6>
                            <div id="publicationDetailUseCasesMapping"></div>
                        </div>
                    </div>

                    <div class="card detail-section-separator">
                        <div class="card-body">
                            <h6>Shortcomings & Risks</h6>
                            <p><strong>Shortcomings:</strong> <span id="publicationDetailShortcomings"></span></p>
                            <p><strong>Risks:</strong> <span id="publicationDetailRisks"></span></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="downloadPDF('publication')">Download PDF</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Global Search Results Modal -->
    <div class="modal fade" id="globalSearchResultsModal" tabindex="-1" aria-labelledby="globalSearchResultsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="globalSearchResultsModalLabel">Global Search Results</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="globalSearchResultsContent" class="row row-cols-1 g-4">
                        <!-- Search results will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Heatmap Drilldown Papers Modal (now used by showHeatmapCellDetail) -->
    <div class="modal fade" id="heatmapDetailModal" tabindex="-1" aria-labelledby="heatmapDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="heatmapDetailModalLabel">Heatmap Drill-down: <span id="heatmapDetailTitleSpan"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Relevant Research for <strong id="heatmapDetailCriteria"></strong>:</p>
                    <ul id="heatmapDrilldownPaperList" class="list-disc list-inside space-y-1">
                        <!-- Papers will be loaded here -->
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="downloadHeatmapDrilldownAsCSV()">Download Papers (CSV)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Generic Strategic Entry Detail Modal -->
    <div class="modal fade" id="strategicEntryDetailModal" tabindex="-1" aria-labelledby="strategicEntryDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="strategicEntryDetailModalLabel">Strategic Insight Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="strategicEntryDetailModalBody">
                    <!-- Content will be dynamically loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="downloadStrategicEntryPdfBtn">Download PDF</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Generic Heatmap Header/Cell Detail Modal -->
    <div class="modal fade" id="heatmapHeaderCellDetailModal" tabindex="-1" aria-labelledby="heatmapHeaderCellDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="heatmapHeaderCellDetailModalLabel">Detail Overview</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="heatmapHeaderCellDetailModalBody">
                    <!-- Content will be dynamically loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="downloadHeatmapHeaderCellPdfBtn">Download PDF</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
         })(window, document, "clarity", "script", "sf9jz6kg3u");
    </script>

    <script>
        let allPatents = [];
        let allPublications = [];
        let allData = []; // Combined for global search and insights
        let currentPatents = [];
        let currentPublications = [];
        let currentChartInstances = {}; // To manage chart instances (no longer needed for charts, but kept for consistency if charts are re-introduced)
        let currentCategoryFilter = []; // Changed to array for multi-selection
        let currentFilters = { // New filter for categories page
            patents: {},
            publications: {},
            categories: {}
        };
        let currentDrilldownPapers = []; // To store papers for heatmap drilldown download
        let strategicDataCache = {}; // Cache for strategic insight JSON data (full reports)
        let currentStrategicEntryDetail = null; // To store the currently viewed strategic entry for PDF download
        let currentHeatmapHeaderCellDetail = null; // To store the currently viewed heatmap header/cell detail for PDF download

        let searchableData = []; // Unified data for market view search
        let cloudItemDataMap = {}; // New: Map to store full data for cloud items for easy lookup

        // Define the heatmap configurations directly in the script, as found in HeatMap.HTML
        // These contain the heatmap data and the paper mappings for drill-down.
        const heatmapConfigs = [
            {
                type: 'industry', // Used for navigation and detail page lookup
                title: 'Industry Sector Strength',
                tableId: 'industry-heatmap',
                rowHeaders: ['Robotics & Industrial Automation', 'Automotive & Future Mobility', 'Healthcare & MedTech', 'Media & Entertainment', 'FinTech & BFSI', 'E-commerce & Retail', 'Software Dev & MLOps', 'Cybersecurity', 'EdTech', 'Smart Cities & Infrastructure', 'Drugs & Pharmaceuticals'],
                columnHeaders: ['3D Vision & NeRFs', 'Robotic Planning & Control', 'Autonomous Navigation & SLAM', 'Document Intelligence', 'Generative Models (NLG/TTS/Vision)', 'Fairness, Trust & Privacy', 'Blockchain & Game Theory', 'HPC & Compilers'],
                data: {
                    'Robotics & Industrial Automation': [6, 6, 3, 0, 2, 2, 0, 0], 'Automotive & Future Mobility': [6, 3, 8, 2, 1, 1, 0, 0], 'Healthcare & MedTech': [4, 1, 0, 3, 3, 3, 0, 0], 'Media & Entertainment': [4, 0, 0, 2, 7, 0, 0, 0], 'FinTech & BFSI': [0, 0, 0, 3, 1, 3, 5, 0], 'E-commerce & Retail': [1, 1, 0, 1, 0, 3, 2, 0], 'Software Dev & MLOps': [0, 0, 0, 2, 3, 4, 0, 3], 'Cybersecurity': [0, 1, 0, 0, 1, 0, 4, 0], 'EdTech': [0, 0, 0, 1, 2, 1, 0, 0], 'Smart Cities & Infrastructure': [2, 2, 1, 2, 0, 1, 2, 0], 'Drugs & Pharmaceuticals': [3, 0, 0, 0, 1, 2, 0, 0]
                },
                paperMapping: {
                    'Robotics & Industrial Automation': { '3D Vision & NeRFs': ["SCARP: 3D Shape Completion", "MANUS: Markerless Grasp Capture", "GSN: Generalisable Segmentation", "Interactive Segmentation of Radiance Fields", "HyP-NeRF: Learning Improved NeRF Priors", "ConDor: Self-Supervised Canonicalization"], 'Robotic Planning & Control': ["EDMP: Ensemble-of-costs-guided Diffusion", "Modeling and Control of PANTHERA", "RTVS: A Lightweight Differentiable MPC", "DFVS: Deep Flow Guided Scene Agnostic", "Bi-Convex Approximation of Non-Holonomic", "Aerial Transportation of Unknown Payloads"] },
                    'Automotive & Future Mobility': { 'Autonomous Navigation & SLAM': ["Topological Mapping for Manhattan-like", "Drift Reduced Navigation", "RP-VIO: Robust Plane-based", "Open-World Object Detection", "Ground then Navigate", "Referring Navigable Regions", "Multi-Relational Graph Convolutional Network", "Bi-Convex Approximation of Non-Holonomic"] },
                    'Healthcare & MedTech': { '3D Vision & NeRFs': ["CheXtriev: Anatomy-Centered", "BeSt-LeS: Benchmarking Stroke Lesion", "Weakly supervised instance segmentation", "Efficient and Generic Interactive"], 'Generative Models (NLG/TTS/Vision)': ["Towards Accurate Lip-to-Speech", "StethoSpeech: Speech Generation", "Learning Individual Speaking Styles", "StethoSpeech: Speech Generation", "Towards Improving NAM-to-Speech"] }
                }
            },
            {
                type: 'company',
                title: 'Company Alignment Strength',
                tableId: 'company-heatmap',
                rowHeaders: ['Google', 'Microsoft', 'Amazon', 'Nvidia', 'Apple', 'Salesforce', 'SAP', 'Adobe', 'Flipkart', 'Zomato & Swiggy', 'Qualcomm', 'Oracle', 'Intel', 'Intuit', 'MakeMyTrip', 'Zoho', 'Freshworks', 'Postman', 'BrowserStack', 'Atlassian'],
                columnHeaders: ['Autonomous Systems', 'Cloud AI & MLOps', '3D Vision & AR/VR', 'Document Intelligence', 'Generative AI', 'Speech & NLP', 'Fairness & Trust', 'Robotics', 'Cybersecurity & Blockchain'],
                data: { 'Google': [10, 5, 6, 3, 3, 3, 2, 2, 1], 'Microsoft': [2, 6, 5, 4, 5, 4, 2, 1, 1], 'Amazon': [4, 6, 2, 1, 3, 3, 3, 7, 0], 'Nvidia': [8, 2, 8, 0, 6, 1, 0, 1, 0], 'Apple': [4, 2, 7, 1, 2, 3, 2, 3, 1], 'Salesforce': [0, 3, 0, 2, 1, 3, 4, 0, 0], 'SAP': [0, 2, 0, 6, 1, 3, 1, 0, 0], 'Adobe': [0, 0, 3, 3, 6, 2, 0, 0, 0], 'Flipkart': [1, 0, 0, 3, 0, 5, 0, 2, 0], 'Zomato & Swiggy': [0, 0, 0, 1, 0, 4, 1, 1, 0], 'Qualcomm': [3, 1, 4, 0, 1, 2, 0, 0, 2], 'Oracle': [0, 3, 0, 1, 0, 1, 0, 0, 2], 'Intel': [1, 1, 0, 0, 0, 0, 0, 0, 2], 'Intuit': [0, 0, 0, 4, 0, 1, 2, 0, 0], 'MakeMyTrip': [0, 0, 0, 0, 2, 3, 1, 0, 1], 'Zoho': [0, 1, 0, 5, 3, 4, 0, 0, 0], 'Freshworks': [0, 1, 1, 1, 1, 4, 1, 0, 0], 'Postman': [0, 1, 0, 2, 2, 2, 1, 0, 1], 'BrowserStack': [1, 1, 0, 1, 0, 1, 0, 0, 0], 'Atlassian': [0, 1, 0, 2, 2, 2, 1, 0, 1] },
                paperMapping: { 'Google': { 'Autonomous Systems': ["GDIP: Gated Differentiable Image Processing", "Open-World Object Detection", "Talk2BEV: Language-enhanced", "ATPPNet: Attention based Temporal", "Hilbert Space Embedding-Based", "LeGo-Drive: Language-enhanced", "Ground then Navigate", "CueCAn: Cue Driven Contextual", "LiDAR guided Small obstacle", "Drift Reduced Navigation"] }, 'Amazon': { 'Robotics': ["EDMP: Ensemble-of-costs-guided", "Topological Mapping for Manhattan-like", "Anticipate & Act", "SCARP: 3D Shape Completion", "MANUS: Markerless Grasp Capture", "Sequence-Agnostic Multi-Object", "Human-Robot Collaboration for Logistics"] } }
            },

            {
                type: 'productwise',
                title: 'Product Application Strength',
                tableId: 'product-heatmap',
                rowHeaders: ['OpenAI GPT-4 API', 'Nvidia Omniverse', 'MS GitHub Copilot', ' ' +
                'Scale AI Platform', 'Hugging Face Hub', 'Salesforce Einstein', 'Adobe Firefly', 'Intuit QuickBooks', 'Apple Vision Pro', 'Waymo One Service', 'Boston Dynamics Spot', 'Ather 450X Scooter', 'Amazon Proteus Robot', 'Google Lens', 'Swiggy Instamart', 'Flipkart Ekart', 'Razorpay Fraud Engine', 'CRED Reward System', 'HERE HD Live Map', 'MS Teams Summarization'],
                columnHeaders: ['Generative AI', '3D Vision & NeRFs', 'Robotics & SLAM', 'NLP & Summarization', 'Fairness & Trust', 'Document Intelligence', 'HPC & Compilers', 'Adversarial ML', 'Game Theory & Blockchain'],
                data: { 'OpenAI GPT-4 API': [3, 0, 0, 4, 1, 1, 0, 2, 0], 'Nvidia Omniverse': [6, 8, 1, 0, 0, 0, 0, 0, 0], 'MS GitHub Copilot': [3, 0, 0, 4, 0, 1, 1, 0, 0], 'Scale AI Platform': [0, 2, 0, 0, 3, 2, 0, 0, 2], 'Hugging Face Hub': [1, 0, 0, 4, 1, 1, 0, 1, 0], 'Salesforce Einstein': [1, 0, 0, 2, 4, 1, 0, 0, 0], 'Adobe Firefly': [6, 1, 0, 2, 0, 0, 0, 0, 0], 'Intuit QuickBooks': [0, 0, 0, 1, 1, 4, 0, 0, 0], 'Apple Vision Pro': [1, 6, 5, 1, 1, 0, 0, 0, 0], 'Waymo One Service': [0, 5, 6, 2, 2, 1, 0, 1, 0], 'Boston Dynamics Spot': [0, 1, 8, 1, 1, 0, 0, 0, 0], 'Ather 450X Scooter': [0, 2, 2, 0, 0, 0, 0, 0, 1], 'Amazon Proteus Robot': [0, 1, 6, 0, 2, 0, 0, 0, 0], 'Google Lens': [0, 3, 1, 4, 0, 2, 0, 0, 0], 'Swiggy Instamart': [0, 0, 2, 1, 0, 0, 0, 0, 2], 'Flipkart Ekart': [0, 0, 1, 0, 0, 5, 0, 0, 0], 'Razorpay Fraud Engine': [0, 0, 0, 0, 1, 1, 0, 0, 2], 'CRED Reward System': [1, 0, 0, 1, 3, 0, 0, 0, 2], 'HERE HD Live Map': [0, 3, 1, 0, 0, 2, 0, 0, 0], 'MS Teams Summarization': [2, 0, 0, 5, 0, 0, 0, 0, 0] },
                paperMapping: {
                    'OpenAI GPT-4 API': {
                        'NLP & Summarization': [
                            "Efficient Long Document Summarization with Transformers",
                            "Abstractive Text Summarization using Pointer-Generator Networks",
                            "Question Answering with Pre-trained Language Models",
                            "Neural Machine Translation with Attention Mechanisms"
                        ]
                    },
                    'Nvidia Omniverse': { 'Generative AI': ["Action-GPT: Leveraging Large-scale", "MeronymNet: A Hierarchical Approach", "xCloth: Extracting Template-free", "Extreme-scale Talking-Face Video", "Wav2Lip: A lip sync expert", "HyP-NeRF: Learning Improved NeRF Priors"], '3D Vision & NeRFs': ["GSN: Generalisable Segmentation", "Interactive Segmentation of Radiance Fields", "MANUS: Markerless Grasp Capture", "DiVa-360: The Dynamic Visual Dataset", "Canonical Fields: Self-Superified Canonicalization", "ConDor: Self-Superified Canonicalization", "DRACO: Weakly Supervised Dense", "PoseFromGraph: Compact 3-D Pose"]
                    }
                }
            },
            //{
            //    type: 'productwise',
            //    title: 'Product Application Strength',
            //    tableId: 'product-heatmap',
            //    rowHeaders: ['Smartphone', 'Laptop', 'Smart TV', 'Wireless Earbuds', 'Refrigerator', 'Air Conditioner', 'Washing Machine', 'Robotic Vacuum Cleaner', 'Sedan Car (e.g., Honda City / Hyundai Verna)', 'Electric Scooter (e.g., Ather / Ola S1)', 'Running Shoe', 'T-Shirt', 'Backpack', 'Packaged Milk', 'Instant Noodles', 'Bottled Water', 'Toothbrush (Electric / Smart Variant)', 'Air Purifier', 'Toy Drone', 'Board Game (e.g., Ludo, Chess)'],
            //    columnHeaders: ['Generative AI', '3D Vision & NeRFs', 'Robotics & SLAM', 'NLP & Summarization', 'Fairness & Trust', 'Document Intelligence', 'HPC & Compilers', 'Adversarial ML', 'Game Theory & Blockchain'],
            //    data: {
            //        'Smartphone': [3, 6, 0, 4, 1, 0, 1, 0, 0], 'Laptop': [0, 0, 0, 0, 2, 0, 2, 0, 2], 'Smart TV': [0, 0, 0, 4, 0, 0, 0, 0, 2], 'Wireless Earbuds': [0, 0, 0, 2, 0, 0, 0, 0, 2],
            //        'Refrigerator': [0, 2, 0, 0, 0, 0, 0, 0, 2], 'Air Conditioner': [0, 1, 0, 0, 1, 0, 0, 0, 0], 'Washing Machine': [0, 2, 0, 0, 0, 0, 0, 0, 0], 'Robotic Vacuum Cleaner': [0, 2, 2, 0, 1, 0, 0, 0, 2],
            //        'Sedan Car (e.g., Honda City / Hyundai Verna)': [0, 3, 2, 2, 0, 0, 0, 0, 2], 'Electric Scooter (e.g., Ather / Ola S1)': [0, 2, 2, 0, 0, 0, 0, 0, 1],
            //        'Running Shoe': [0, 0, 0, 0, 0, 0, 0, 0, 1], 'T-Shirt': [1, 2, 0, 0, 0, 0, 0, 0, 2], 'Backpack': [0, 0, 0, 0, 0, 0, 0, 0, 1],
            //        'Packaged Milk': [0, 0, 0, 0, 0, 0, 0, 0, 1], 'Instant Noodles': [0, 0, 0, 1, 0, 0, 0, 0, 1], 'Bottled Water': [0, 0, 0, 0, 0, 0, 0, 0, 2],
            //        'Toothbrush (Electric / Smart Variant)': [0, 0, 0, 0, 0, 0, 0, 0, 1], 'Air Purifier': [0, 0, 0, 0, 0, 0, 0, 0, 1],
            //        'Toy Drone': [0, 0, 2, 0, 0, 0, 0, 0, 2], 'Board Game (e.g., Ludo, Chess)': [0, 0, 0, 2, 0, 0, 0, 0, 2]
            //    },
            //    paperMapping: {
            //        'OpenAI GPT-4 API': {
            //            'NLP & Summarization': [
            //                "Efficient Long Document Summarization with Transformers",
            //                "Abstractive Text Summarization using Pointer-Generator Networks",
            //                "Question Answering with Pre-trained Language Models",
            //                "Neural Machine Translation with Attention Mechanisms"
            //            ]
            //        },
            //        'Nvidia Omniverse': { 'Generative AI': ["Action-GPT: Leveraging Large-scale", "MeronymNet: A Hierarchical Approach", "xCloth: Extracting Template-free", "Extreme-scale Talking-Face Video", "Wav2Lip: A lip sync expert", "HyP-NeRF: Learning Improved NeRF Priors"], '3D Vision & NeRFs': ["GSN: Generalisable Segmentation", "Interactive Segmentation of Radiance Fields", "MANUS: Markerless Grasp Capture", "DiVa-360: The Dynamic Visual Dataset", "Canonical Fields: Self-Superified Canonicalization", "ConDor: Self-Superified Canonicalization", "DRACO: Weakly Supervised Dense", "PoseFromGraph: Compact 3-D Pose"]
            //        }
            //    }
            //},
            {
                type: 'social',
                title: 'Social Impact',
                tableId: 'social-heatmap',
                rowHeaders: ['Public Health & Safety', 'Accessibility & Inclusion', 'Governance & Infrastructure', 'Public Policy & Education'],
                columnHeaders: ['Health Diagnostics', 'Assistive Tech (Speech/Sign)', 'NLP for Social Good', 'Robotics & Drones', 'Fairness & Social Choice', 'Cybersecurity & Blockchain', 'Infrastructure & Smart Cities'],
                data: { 'Public Health & Safety': [4, 0, 5, 2, 0, 2, 2], 'Accessibility & Inclusion': [1, 5, 3, 0, 3, 0, 0], 'Governance & Infrastructure': [0, 0, 3, 1, 2, 3, 5], 'Public Policy & Education': [0, 2, 6, 0, 1, 0, 0] },
                paperMapping: { 'Accessibility & Inclusion': { 'Assistive Tech (Speech/Sign)': ["Towards Automatic Speech to Sign Language Generation", "Towards Accurate Lip-to-Speech Synthesis", "Learning Individual Speaking Styles", "StethoSpeech: Speech Generation", "Towards Improving NAM-to-Speech"] } }
            },
            {
                type: 'sdg',
                title: 'UN Sustainable Development Goal (SDG) Alignment',
                tableId: 'sdg-heatmap',
                rowHeaders: ['SDG 3: Good Health', 'SDG 4: Quality Education', 'SDG 7: Clean Energy', 'SDG 9: Infrastructure', 'SDG 10: Reduced Inequalities', 'SDG 11: Sustainable Cities', 'SDG 12: Sustainability', 'SDG 16: Peace & Justice'],
                columnHeaders: ['Health Tech', 'Assistive Tech', 'Education Tech', 'Sustainable & Green AI', 'Fairness & Inclusion', 'Infrastructure & Smart Cities', 'Blockchain & Governance'],
                data: { 'SDG 3: Good Health': [6, 2, 0, 0, 1, 0, 0], 'SDG 4: Quality Education': [0, 1, 4, 0, 1, 0, 0], 'SDG 7: Clean Energy': [0, 0, 0, 1, 0, 3, 0], 'SDG 9: Infrastructure': [0, 0, 0, 1, 0, 6, 1], 'SDG 10: Reduced Inequalities': [1, 5, 1, 0, 5, 0, 1], 'SDG 11: Sustainable Cities': [1, 0, 0, 1, 2, 7, 1], 'SDG 12: Sustainability': [0, 0, 0, 4, 1, 0, 0], 'SDG 16: Peace & Justice': [0, 0, 0, 0, 3, 1, 5] },
                paperMapping: { 'SDG 11: Sustainable Cities': { 'Infrastructure & Smart Cities': ["City-Scale Pollution Aware Traffic", "Open-World Object Detection", "Understanding Dynamic Scenes", "Combinatorial Civic Crowdfunding", "Exploratory Study of oneM2M-based", "Automated Infrastructure Auditing", "Topological Mapping for Manhattan-like"] } }
            },
            
            //{
            //    type: 'lm',
            //    title: 'Learning Management',
            //    tableId: 'lm-heatmap',
            //    rowHeaders: [], // Will be populated dynamically from Learning_Management.json micro_sectors
            //    columnHeaders: ['AI/ML for Education', 'Language Learning', 'Robotics & Control', 'Knowledge Extraction', 'NLP & Summarization', 'Skill Assessment', 'Personalized Learning', 'Document Intelligence'],
           //     data: {}, // Will be populated dynamically
            //    paperMapping: {} // Will be populated dynamically
           // }
            
        ];


        // Updated badgeColors to provide outline effect with darker colors
        const badgeColors = [
            '#004D40', // Dark Green
            '#1A237E', // Dark Blue
            '#311B92', // Dark Purple
            '#B71C1C', // Dark Red
            '#4E342E', // Dark Brown
            '#006064', // Dark Cyan
            '#212121', // Very Dark Grey
            '#424242', // Dark Grey
            '#616161', // Medium Dark Grey
            '#D32F2F'  // Slightly brighter dark red
        ];

        // Utility function to get a consistent badge color for a given text
        function getBadgeColorClass(text) {
            let hash = 0;
            for (let i = 0; i < text.length; i++) {
                hash = text.charCodeAt(i) + ((hash << 5) - hash);
            }
            const index = Math.abs(hash) % badgeColors.length;
            return badgeColors[index];
        }

        // Helper to extract 1-2 word use case for publications
        function extractUseCase(useCases) {
            if (useCases) {
                if (useCases.Complete && useCases.Complete.length > 0) {
                    return useCases.Complete[0].split(':')[0].trim().split(' ').slice(0, 2).join(' ');
                }
                if (useCases.Partial && useCases.Partial.length > 0) {
                    return useCases.Partial[0].split(':')[0].trim().split(' ').slice(0, 2).join(' ');
                }
                if (useCases.Low && useCases.Low.length > 0) {
                    return useCases.Low[0].split(':')[0].trim().split(' ').slice(0, 2).join(' ');
                }
            }
            return 'N/A';
        }

        // --- Heatmap Helper Functions ---
        // Improved getColorForValue for a better visual gradient
        function getColorForValue(value) {
            if (value === 0) return '#f8f9fa'; // Very light grey for zero
            // A gradient from light primary to darker primary color
            const colors = [
                '#e0f2f1', // Very light teal
                '#b2dfdb',
                '#80cbc4',
                '#4db6ac',
                '#26a69a',
                '#009688', // Primary color
                '#00897b',
                '#00796b',
                '#00695c',
                '#004d40'  // Darkest teal
            ];
            const index = Math.min(value - 1, colors.length - 1); // Adjusted to be 0-indexed for array
            return colors[index];
        }
        
        // Modified generateHeatmapTable to accept an 'origin' parameter
        function generateHeatmapTable(config, origin = 'strategic-insights') {
            const { title, tableId, rowHeaders, columnHeaders, data } = config;
            // Removed View Full Report button from here
            let tableHtml = `
                <div class="heatmap-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="my-0">Heatmap: ${title}</h4>
                    </div>
                    <div class="mb-3 d-flex flex-wrap gap-2">
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="rowHeaderFilterDropdown-${tableId}" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                                Filter Rows
                            </button>
                            <ul class="dropdown-menu p-3" aria-labelledby="rowHeaderFilterDropdown-${tableId}" style="max-height: 300px; overflow-y: auto;">
                                ${rowHeaders.map(header => `
                                    <li>
                                        <div class="form-check">
                                            <input class="form-check-input heatmap-row-filter" type="checkbox" value="${header}" id="rowFilter_${tableId}_${header.replace(/\s/g, '_').replace(/&/g, 'and')}" checked data-table-id="${tableId}" onchange="applyHeatmapFilters('${tableId}')">
                                            <label class="form-check-label" for="rowFilter_${tableId}_${header.replace(/\s/g, '_').replace(/&/g, 'and')}">${header}</label>
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="colHeaderFilterDropdown-${tableId}" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                                Filter Columns
                            </button>
                            <ul class="dropdown-menu p-3" aria-labelledby="colHeaderFilterDropdown-${tableId}" style="max-height: 300px; overflow-y: auto;">
                                ${columnHeaders.map(header => `
                                    <li>
                                        <div class="form-check">
                                            <input class="form-check-input heatmap-col-filter" type="checkbox" value="${header}" id="colFilter_${tableId}_${header.replace(/\s/g, '_').replace(/&/g, 'and')}" checked data-table-id="${tableId}" onchange="applyHeatmapFilters('${tableId}')">
                                            <label class="form-check-label" for="colFilter_${tableId}_${header.replace(/\s/g, '_').replace(/&/g, 'and')}">${header}</label>
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        <button class="btn btn-outline-secondary" onclick="clearHeatmapFilters('${tableId}')">Clear All Filters</button>
                    </div>
                    <table id="${tableId}-table">
                        <thead>
                            <tr>
                                <th class="row-header"></th>
                                ${columnHeaders.map(header => `<th class="col-header clickable-header" onclick="showHeatmapHeaderDetail('${config.type}', '${header}', 'column')">${header}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;
            rowHeaders.forEach(rowHeader => {
                tableHtml += `<tr class="row-data" data-row-header="${rowHeader}">`;
                tableHtml += `<td class="row-header clickable-header" onclick="showHeatmapHeaderDetail('${config.type}', '${rowHeader}', 'row')">${rowHeader}</td>`;
                const rowData = data[rowHeader] || Array(columnHeaders.length).fill(0);
                rowData.forEach((value, colIndex) => {
                    const color = getColorForValue(value);
                    const textColor = value > 5 ? 'dark-text' : ''; // Keep dark-text for higher values
                    const colHeader = columnHeaders[colIndex];
                    // Removed onclick from value-cell as per request
                    tableHtml += `<td class="value-cell ${textColor}" style="background-color: ${color};" 
                                    data-col-header="${colHeader}">
                                    ${value > 0 ? value : ''}
                                  </td>`;
                });
                tableHtml += `</tr>`;
            });
            tableHtml += `</tbody></table></div>`;
            return tableHtml;
        }

        function applyHeatmapFilters(tableId) {
            const tableElement = document.getElementById(`${tableId}-table`);
            if (!tableElement) return;

            const selectedRows = Array.from(document.querySelectorAll(`#rowHeaderFilterDropdown-${tableId} ~ .dropdown-menu .heatmap-row-filter:checked`)).map(cb => cb.value);
            const selectedCols = Array.from(document.querySelectorAll(`#colHeaderFilterDropdown-${tableId} ~ .dropdown-menu .heatmap-col-filter:checked`)).map(cb => cb.value);

            // Filter rows
            tableElement.querySelectorAll('.row-data').forEach(row => {
                const rowHeader = row.dataset.rowHeader;
                if (selectedRows.includes(rowHeader)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });

            // Filter columns
            // First, hide/show column headers
            const headerRow = tableElement.querySelector('thead tr');
            if (headerRow) {
                Array.from(headerRow.querySelectorAll('.col-header')).forEach(headerCell => {
                    const colHeader = headerCell.textContent;
                    if (selectedCols.includes(colHeader)) {
                        headerCell.style.display = '';
                    } else {
                        headerCell.style.display = 'none';
                    }
                });
            }

            // Then, hide/show cells in the body
            tableElement.querySelectorAll('tbody tr').forEach(row => {
                Array.from(row.querySelectorAll('.value-cell')).forEach(cell => {
                    const colHeader = cell.dataset.colHeader;
                    if (selectedCols.includes(colHeader)) {
                        cell.style.display = '';
                    } else {
                        cell.style.display = 'none';
                    }
                });
            });
        }

        function clearHeatmapFilters(tableId) {
            // Check all row filter checkboxes
            document.querySelectorAll(`#rowHeaderFilterDropdown-${tableId} ~ .dropdown-menu .heatmap-row-filter`).forEach(cb => {
                cb.checked = true;
            });
            // Check all column filter checkboxes
            document.querySelectorAll(`#colHeaderFilterDropdown-${tableId} ~ .dropdown-menu .heatmap-col-filter`).forEach(cb => {
                cb.checked = true;
            });
            applyHeatmapFilters(tableId); // Apply filters to reset the display
        }

        // Helper function to recursively display object properties
        function displayObjectProperties(obj, indent = 0) {
            let html = '';
            const indentStyle = `margin-left: ${indent * 1.5}rem;`;

            for (const key in obj) {
                if (Object.prototype.hasOwnProperty.call(obj, key)) {
                    const value = obj[key];
                    // Trim the key before formatting to handle leading spaces
                    const formattedKey = key.trim().replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase());

                    if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                        html += `<div class="detail-item-property" style="${indentStyle}"><strong>${formattedKey}:</strong></div>`;
                        html += displayObjectProperties(value, indent + 1);
                    } else if (Array.isArray(value)) {
                        html += `<div class="detail-item-property" style="${indentStyle}"><strong>${formattedKey}:</strong></div>`;
                        html += `<ul style="${indentStyle} list-style-type: disc; padding-left: 2rem;">`;
                        value.forEach(item => {
                            if (typeof item === 'object' && item !== null) {
                                html += `<li>${displayObjectProperties(item, 0)}</li>`; // Recursive call for array of objects
                            } else {
                                html += `<li>${item}</li>`;
                            }
                        });
                        html += `</ul>`;
                    } else {
                        html += `<div class="detail-item-property" style="${indentStyle}"><strong>${formattedKey}:</strong> ${value}</div>`;
                    }
                }
            }
            return html;
        }

        // --- Strategic Insights HTML Generation Functions (Modified for full page rendering) ---
        // Modified to accept originPage for back button
        function getProductwiseInsightsHtml(data, originPage) {
            const backButtonAction = originPage === 'market' ? `showPage('dashboard', { view: 'market' })` : `showPage('strategic-insights')`;
            const backButtonText = originPage === 'market' ? 'Back to Dashboard (Market View)' : 'Back to Strategic Insights';

            let html = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <button class="btn btn-outline-secondary" onclick="${backButtonAction}"><i class="fas fa-arrow-left"></i> ${backButtonText}</button>
                    <h2 class="text-secondary mb-0">Product-wise Insights</h2>
                    <button class="btn btn-primary" onclick="downloadPDF('productwise')">Download PDF</button>
                </div>
                <p class="lead">Detailed analysis of product-wise technology and use case alignment.</p>
            `;
            // Ensure data is an object and iterate through its values (categories)
            if (data && typeof data === 'object') {
                for (const categoryName in data) {
                    if (Object.prototype.hasOwnProperty.call(data, categoryName)) {
                        const productsInCategory = data[categoryName];
                        html += `
                            <div class="col-12 mb-4 detail-section-separator">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h5 class="card-title mb-0">${categoryName}</h5>
                                    </div>
                                    <div class="card-body">
                                        ${productsInCategory && Array.isArray(productsInCategory) ? productsInCategory.map(product => `
                                            <div class="mb-3">
                                                <h6>${product.product_name}</h6>
                                                <p class="text-muted">${product.description}</p>
                                                <ul class="list-group list-group-flush">
                                                    ${product.strategic_areas && Array.isArray(product.strategic_areas) ? product.strategic_areas.map(area => `
                                                        <li class="list-group-item">
                                                            <strong>${area.name}:</strong> ${area.problem || 'N/A'}
                                                            <ul style="padding-left: 1.5rem;">
                                                                <li><strong>Publications:</strong> ${area.core_technologies[" publications"] || 'N/A'}</li>
                                                                <li><strong>Patents:</strong> ${area.core_technologies[" patents"] || 'N/A'}</li>
                                                                ${area.integration_and_impact && area.integration_and_impact !== 'N/A' ? `<li><strong>Integration & Impact:</strong> ${area.integration_and_impact}</li>` : ''}
                                                            </ul>
                                                        </li>
                                                    `).join('') : '<p>No strategic areas available.</p>'}
                                                </ul>
                                            </div>
                                        `).join('') : '<p>No products available.</p>'}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
            } else {
                html += `<div class="alert alert-info" role="alert">No product-wise insights data available.</div>`;
            }
            return html;
        }

        // Modified to accept originPage for back button
        function getSdgInsightsHtml(data, originPage) {
            const backButtonAction = originPage === 'market' ? `showPage('dashboard', { view: 'market' })` : `showPage('strategic-insights')`;
            const backButtonText = originPage === 'market' ? 'Back to Dashboard (Market View)' : 'Back to Strategic Insights';

            let html = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <button class="btn btn-outline-secondary" onclick="${backButtonAction}"><i class="fas fa-arrow-left"></i> ${backButtonText}</button>
                    <h2 class="text-secondary mb-0">SDG Alignment </h2>
                    <button class="btn btn-primary" onclick="downloadPDF('sdg')">Download PDF</button>
                </div>
                <p class="lead">Detailed analysis of how technologies align with various Sustainable Development Goals.</p>
            `;
            // Ensure data.sustainable_development_goals is an array
            if (data && data.sustainable_development_goals && Array.isArray(data.sustainable_development_goals)) {
                data.sustainable_development_goals.forEach(sdg => {
                    html += `
                        <div class="col-12 mb-4 detail-section-separator">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="card-title mb-0">${sdg.sdg_id}: ${sdg.title}</h5>
                                    <p class="card-text text-muted">${sdg.description || 'N/A'}</p>
                                </div>
                                <div class="card-body">
                                    <h6>Applications:</h6>
                                    <ul class="list-group list-group-flush">
                                        ${sdg.applications && Array.isArray(sdg.applications) ? sdg.applications.map(app => `
                                            <li class="list-group-item">
                                                <strong>${app.application_name}:</strong> ${app.description || 'N/A'}
                                                <br>
                                                <small class="text-muted">Relevant Research: ${app.relevant_research || 'N/A'}</small>
                                            </li>
                                        `).join('') : '<p>No applications available.</p>'}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `<div class="alert alert-info" role="alert">No SDG insights data available.</div>`;
            }
            return html;
        }
        
        // Modified to accept originPage for back button
        function getSocialInsightsHtml(data, originPage) {
            const backButtonAction = originPage === 'market' ? `showPage('dashboard', { view: 'market' })` : `showPage('strategic-insights')`;
            const backButtonText = originPage === 'market' ? 'Back to Dashboard (Market View)' : 'Back to Strategic Insights';

            let html = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <button class="btn btn-outline-secondary" onclick="${backButtonAction}"><i class="fas fa-arrow-left"></i> ${backButtonText}</button>
                    <h2 class="text-secondary mb-0">Social Impact & Gov\'t Application Strength</h2>
                    <button class="btn btn-primary" onclick="downloadPDF('social')">Download PDF</button>
                </div>
                <p class="lead">${data.report_description || 'Detailed analysis of social impact and government application strength.'}</p>
            `;
            // Ensure data.application_themes is an array
            if (data && data.application_themes && Array.isArray(data.application_themes)) {
                data.application_themes.forEach(theme => {
                    html += `
                        <div class="col-12 mb-4 detail-section-separator">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="card-title mb-0">${theme.theme_name}</h5>
                                </div>
                                <div class="card-body">
                                    <h6>Applications:</h6>
                                    <ul class="list-group list-group-flush">
                                        ${theme.applications && Array.isArray(theme.applications) ? theme.applications.map(app => `
                                            <li class="list-group-item">
                                                <strong>${app.title}:</strong> ${app.application_description || 'N/A'}
                                                <br>
                                                <small class="text-muted">Relevant Research: ${app.relevant_research || 'N/A'}</small>
                                            </li>
                                        `).join('') : '<p>No applications available.</p>'}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `<div class="alert alert-info" role="alert">No social impact insights data available.</div>`;
            }
            return html;
        }
        
        // Modified to accept originPage for back button
        function getIndustryInsightsHtml(data, originPage) {
            const backButtonAction = originPage === 'market' ? `showPage('dashboard', { view: 'market' })` : `showPage('strategic-insights')`;
            const backButtonText = originPage === 'market' ? 'Back to Dashboard (Market View)' : 'Back to Strategic Insights';

            let html = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <button class="btn btn-outline-secondary" onclick="${backButtonAction}"><i class="fas fa-arrow-left"></i> ${backButtonText}</button>
                    <h2 class="text-secondary mb-0">Industry-wise Insights</h2>
                    <button class="btn btn-primary" onclick="downloadPDF('industry')">Download PDF</button>
                </div>
                <p class="lead">Comprehensive insights into technology applications across various industry sectors.</p>
            `;
            // Ensure data.industry_sectors is an array
            if (data && data.industry_sectors && Array.isArray(data.industry_sectors)) {
                data.industry_sectors.forEach(sector => {
                    html += `
                        <div class="col-12 mb-4 detail-section-separator">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">${sector.sector_name}</h5>
                                    <p class="card-text text-muted">${sector.description || 'N/A'}</p>
                                </div>
                                <div class="card-body">
                                    <h6>Micro-Sectors & Product Concepts:</h6>
                                    <ul class="list-group list-group-flush">
                                        ${sector.micro_sectors && Array.isArray(sector.micro_sectors) ? sector.micro_sectors.map(microSector => `
                                            <li class="list-group-item">
                                                <strong>${microSector.name}:</strong>
                                                <p class="mb-1">Problem: ${microSector.problem || 'N/A'}</p>
                                                <p class="mb-1">Product Concept: ${microSector.product_concept || 'N/A'}</p>
                                                <ul style="padding-left: 1.5rem;">
                                                    <li><strong>Publications:</strong> ${microSector.core_technologies[" publications"] || 'N/A'}</li>
                                                    <li><strong>Patents:</strong> ${microSector.core_technologies[" patents"] || 'N/A'}</li>
                                                </ul>
                                            </li>
                                        `).join('') : '<p>No micro-sectors available.</p>'}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `<div class="alert alert-info" role="alert">No industry-wise insights data available.</div>`;
            }
            return html;
        }
        
        // Modified to accept originPage for back button
        function getCompanyInsightsHtml(data, originPage) {
            const backButtonAction = originPage === 'market' ? `showPage('dashboard', { view: 'market' })` : `showPage('strategic-insights')`;
            const backButtonText = originPage === 'market' ? 'Back to Dashboard (Market View)' : 'Back to Strategic Insights';

            let html = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <button class="btn btn-outline-secondary" onclick="${backButtonAction}"><i class="fas fa-arrow-left"></i> ${backButtonText}</button>
                    <h2 class="text-secondary mb-0">Company-wise Insights</h2>
                    <button class="btn btn-primary" onclick="downloadPDF('company')">Download PDF</button>
                </div>
                <p class="lead">Detailed alignment of company product areas with relevant research and technologies.</p>
            `;
            // Ensure data.companies is an array
            if (data && data.companies && Array.isArray(data.companies)) {
                data.companies.forEach((company) => {
                    html += `
                        <div class="col-12 mb-4 detail-section-separator">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="card-title mb-0">${company.name}</h5>
                                    <p class="card-text text-muted">${company.strategy || 'N/A'}</p>
                                </div>
                                <div class="card-body">
                                    <h6>Strategic Areas:</h6>
                                    <ul class="list-group list-group-flush">
                                        ${company.strategic_areas && Array.isArray(company.strategic_areas) ? company.strategic_areas.map(area => `
                                            <li class="list-group-item">
                                                <strong>${area.Area}:</strong> ${area.problem || 'N/A'}
                                                <ul style="padding-left: 1.5rem;">
                                                    <li><strong>Publications:</strong> ${area.core_technologies[" publications"] || 'N/A'}</li>
                                                    <li><strong>Patents:</strong> ${area.core_technologies[" patents"] || 'N/A'}</li>
                                                    ${area.integration_and_impact && area.integration_and_impact !== 'N/A' ? `<li><strong>Integration & Impact:</strong> ${area.integration_and_impact}</li>` : ''}
                                                </ul>
                                            </li>
                                        `).join('') : '<p>No strategic areas available.</p>'}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `<div class="alert alert-info" role="alert">No company-wise insights data available.</div>`;
            }
            return html;
        }

        // New function for Learning Management Insights HTML
        function getLearningManagementInsightsHtml(data, originPage) {
            const backButtonAction = originPage === 'market' ? `showPage('dashboard', { view: 'market' })` : `showPage('strategic-insights')`;
            const backButtonText = originPage === 'market' ? 'Back to Dashboard (Market View)' : 'Back to Strategic Insights';

            let html = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <button class="btn btn-outline-secondary" onclick="${backButtonAction}"><i class="fas fa-arrow-left"></i> ${backButtonText}</button>
                    <h2 class="text-secondary mb-0">Learning Management Insights</h2>
                    <button class="btn btn-primary" onclick="downloadPDF('lm')">Download PDF</button>
                </div>
                <p class="lead">Detailed analysis of technologies and product concepts within the Learning Management domain.</p>
            `;
            if (data && data.micro_sectors && Array.isArray(data.micro_sectors)) {
                data.micro_sectors.forEach(sector => {
                    html += `
                        <div class="col-12 mb-4 detail-section-separator">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="card-title mb-0">${sector.title}</h5>
                                    <p class="card-text text-muted">${sector.micro_sector_overview || 'N/A'}</p>
                                </div>
                                <div class="card-body">
                                    <h6>Product Concept: ${sector.product_concept?.name || 'N/A'}</h6>
                                    <p class="mb-1"><strong>Problem:</strong> ${sector.product_concept?.problem || 'N/A'}</p>
                                    <p class="mb-1"><strong>Core Technologies:</strong> ${sector.product_concept?.core_technologies || 'N/A'}</p>
                                    <h6 class="mt-3">Relevant Research:</h6>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item"><strong>Publications:</strong>
                                            <ul>
                                                ${sector.research?.publications && Array.isArray(sector.research.publications) ? sector.research.publications.map(pub => `<li>${pub}</li>`).join('') : '<li>N/A</li>'}
                                            </ul>
                                        </li>
                                        <li class="list-group-item"><strong>Patents:</strong>
                                            <ul>
                                                ${sector.research?.patents && Array.isArray(sector.research.patents) ? sector.research.patents.map(pat => `<li>${pat}</li>`).join('') : '<li>N/A</li>'}
                                            </ul>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `<div class="alert alert-info" role="alert">No Learning Management insights data available.</div>`;
            }
            return html;
        }

        // --- Data Loading ---
        async function loadData() {
            try {
                const patentsResponse = await fetch('allpatentsdata.json');
                if (!patentsResponse.ok) throw new Error(`HTTP error! status: ${patentsResponse.status} for allpatentsdata.json`);
                allPatents = await patentsResponse.json();
                currentPatents = [...allPatents]; 

                const publicationsResponse = await fetch('One_Pager_Qualities.json');
                if (!publicationsResponse.ok) throw new Error(`HTTP error! status: ${publicationsResponse.status} for One_Pager_Qualities.json`);
                allPublications = await publicationsResponse.json();
                currentPublications = [...allPublications];

                // Combine data for global search and insights
                allData = [...allPatents.map(p => ({ ...p, type: 'patent' })), ...allPublications.map(pub => ({ ...pub, type: 'publication' }))];

                console.log('Data loaded successfully.');
                console.log('Total Patents:', allPatents.length);
                console.log('Total Publications:', allPublications.length);
                console.log('Total Combined Data for Search:', allData.length);

                // Load strategic data for market view search
                await loadStrategicDataForSearch();
                // Populate LM heatmap config after LM data is loaded
                populateLmHeatmapConfig();

                // Initial render of the dashboard
                renderDashboard(); // This will default to Technology Portfolio View
                renderPatentsPage();
                renderPublicationsPage();
                renderStrategicInsightsPage(); // Render the structure once

                // Show the Dashboard page by default and default to Technology Portfolio View
                showPage('dashboard', { view: 'technology' });

            } catch (error) {
                console.error('Error loading data:', error);
                document.querySelector('.content-section').innerHTML = `<div class="alert alert-danger" role="alert">Failed to load data. Please ensure JSON files are accessible and paths are correct. Error: ${error.message}</div>`;
            }
        }

        // Function to load all strategic JSON data for the market view search
        async function loadStrategicDataForSearch() {
            const files = {
                industry: 'Industrywise_TechUse.json',
                company: 'Companywise_TechUse.json',
                productwise: 'Productwise_TechUse.json',
                sdg: 'SDG_TechUse.json',
                social: 'Social_impact_&_Government_Applications_TechUse.json', // Corrected filename
                lm: 'Learning_Management.json' // Added Learning Management JSON
            };

            for (const key in files) {
                try {
                    const response = await fetch(files[key]);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for ${files[key]}`);
                    strategicDataCache[key] = await response.json();
                } catch (error) {
                    console.error(`Error loading strategic data file ${files[key]}:`, error);
                }
            }
            populateSearchableData(); // Populate the unified searchableData array after all strategic data is loaded
        }

        // Function to populate the Learning Management heatmap configuration
        function populateLmHeatmapConfig() {
            const lmConfig = heatmapConfigs.find(c => c.type === 'lm');
            if (!lmConfig || !strategicDataCache.lm) return;

            const microSectors = strategicDataCache.lm.micro_sectors;
            lmConfig.rowHeaders = microSectors.map(ms => ms.title);

            // Dynamically calculate data and paper mapping
            lmConfig.data = {};
            lmConfig.paperMapping = {};

            const columnTechKeywords = lmConfig.columnHeaders.map(h => h.toLowerCase());

            microSectors.forEach(microSector => {
                const rowData = Array(lmConfig.columnHeaders.length).fill(0);
                const rowPaperMapping = {};

                const allResearchItems = [
                    ...(microSector.research?.publications || []),
                    ...(microSector.research?.patents || [])
                ];

                lmConfig.columnHeaders.forEach((colHeader, colIndex) => {
                    const matchingPapers = [];
                    allResearchItems.forEach(item => {
                        // Simple keyword matching for demonstration.
                        // In a real scenario, this would involve more sophisticated NLP.
                        if (item.toLowerCase().includes(colHeader.toLowerCase().split(' ')[0])) { // Match first word of column header
                            matchingPapers.push(item);
                        }
                    });
                    rowData[colIndex] = matchingPapers.length;
                    if (matchingPapers.length > 0) {
                        rowPaperMapping[colHeader] = matchingPapers;
                    }
                });
                lmConfig.data[microSector.title] = rowData;
                lmConfig.paperMapping[microSector.title] = rowPaperMapping;
            });
            console.log("Learning Management Heatmap Config Populated:", lmConfig);
        }


        // Populate the unified searchableData array for market view search
        function populateSearchableData() {
            let idCounter = 0; // Simple ID for each searchable item
            searchableData = []; // Clear previous data

            // Helper to extract technologies from a given text
            // This version is more robust and handles various formats
            const extractTechnologiesLocal = (text) => {
                if (!text) return [];
                const technologies = [];
                // Regex to capture quoted strings or words followed by (text)
                // or comma-separated words/phrases
                const regex = /"([^"]+)"|\b([\w\s.&/-]+)\s*\((?:from publications|from patents)\)|\b([\w\s.&/-]+?)(?:,\s*|$)/g;
                let match;
                while ((match = regex.exec(text)) !== null) {
                    let techName = match[1] || match[2] || match[3];
                    techName = techName.trim();
                    // Filter out common phrases that are not actual technologies
                    if (techName && techName.length > 2 &&
                        !['from publications', 'from patents', 'method for', 'system for', 'apparatus for', 'research on', 'and'].includes(techName.toLowerCase())) {
                        technologies.push(techName);
                    }
                }
                return [...new Set(technologies)]; // Return unique technologies
            };


            // Process Industry Data
            if (strategicDataCache.industry && strategicDataCache.industry.industry_sectors) {
                strategicDataCache.industry.industry_sectors.forEach(sector => {
                    sector.micro_sectors.forEach(microSector => {
                        const pubTech = extractTechnologiesLocal(microSector.core_technologies[" publications"]);
                        const patentTech = extractTechnologiesLocal(microSector.core_technologies[" patents"]);
                        const allTech = [...new Set([...pubTech, ...patentTech])]; // Unique technologies

                        searchableData.push({
                            id: `market-item-${idCounter++}`,
                            title: microSector.name,
                            summary: microSector.problem,
                            type: 'Industry Micro-Sector',
                            technologies: allTech,
                            sectors: [sector.sector_name],
                            companies: [],
                            products: [],
                            sdgs: [],
                            use_cases: [microSector.product_concept].filter(Boolean), // Use product_concept as a use case
                            fullDetails: {
                                type: 'Industry Micro-Sector',
                                sectorName: sector.sector_name,
                                microSectorName: microSector.name,
                                problem: microSector.problem,
                                productConcept: microSector.product_concept, // Added for full details
                                publications: microSector.core_technologies[" publications"],
                                patents: microSector.core_technologies[" patents"],
                                relevantTechnologies: allTech
                            }
                        });
                    });
                });
            }

            // Process Company Data
            if (strategicDataCache.company && strategicDataCache.company.companies) {
                strategicDataCache.company.companies.forEach(company => {
                    company.strategic_areas.forEach(area => {
                        const pubTech = extractTechnologiesLocal(area.core_technologies[" publications"]);
                        const patentTech = extractTechnologiesLocal(area.core_technologies[" patents"]);
                        const allTech = [...new Set([...pubTech, ...patentTech])];

                        searchableData.push({
                            id: `market-item-${idCounter++}`,
                            title: `${company.name} - ${area.Area}`,
                            summary: area.problem,
                            type: 'Company Strategic Area',
                            technologies: allTech,
                            sectors: [],
                            companies: [company.name],
                            products: [],
                            sdgs: [],
                            use_cases: [], // No direct use cases from this structure
                            fullDetails: {
                                type: 'Company Strategic Area',
                                companyName: company.name,
                                strategicArea: area.Area,
                                problem: area.problem,
                                publications: area.core_technologies[" publications"],
                                patents: area.core_technologies[" patents"],
                                integrationAndImpact: area.integration_and_impact,
                                relevantTechnologies: allTech
                            }
                        });
                    });
                });
            }

            // Process Product Data
            if (strategicDataCache.productwise) {
                // Iterate over the keys (e.g., "Personal Devices", "Home Appliances")
                for (const categoryName in strategicDataCache.productwise) {
                    if (Object.prototype.hasOwnProperty.call(strategicDataCache.productwise, categoryName)) {
                        const productsInCategory = strategicDataCache.productwise[categoryName];
                        productsInCategory.forEach(product => {
                            product.strategic_areas.forEach(area => {
                                const pubTech = extractTechnologiesLocal(area.core_technologies[" publications"]);
                                const patentTech = extractTechnologiesLocal(area.core_technologies[" patents"]);
                                const allTech = [...new Set([...pubTech, ...patentTech])];

                                searchableData.push({
                                    id: `market-item-${idCounter++}`,
                                    title: `${product.product_name} - ${area.name}`,
                                    summary: area.problem,
                                    type: 'Product Strategic Area',
                                    technologies: allTech,
                                    sectors: [categoryName].filter(Boolean), // Product category as sector
                                    companies: [], // Companies using this product, if available in data
                                    products: [product.product_name],
                                    sdgs: [],
                                    use_cases: [area.name].filter(Boolean), // Strategic area name as use case
                                    fullDetails: {
                                        type: 'Product Strategic Area',
                                        productName: product.product_name,
                                        categoryName: categoryName,
                                        strategicArea: area.name,
                                        problem: area.problem,
                                        publications: area.core_technologies[" publications"],
                                        patents: area.core_technologies[" patents"],
                                        integrationAndImpact: area.integration_and_impact,
                                        relevantTechnologies: allTech
                                    }
                                });
                            });
                        });
                    }
                }
            }

            // Process SDG Data
            if (strategicDataCache.sdg && strategicDataCache.sdg.sustainable_development_goals) {
                strategicDataCache.sdg.sustainable_development_goals.forEach(sdg => {
                    sdg.applications.forEach(app => {
                        const relevantResearchTech = extractTechnologiesLocal(app.relevant_research);

                        searchableData.push({
                            id: `market-item-${idCounter++}`,
                            title: `${sdg.sdg_id}: ${sdg.title} - ${app.application_name}`,
                            summary: app.description,
                            type: 'SDG Application',
                            technologies: relevantResearchTech,
                            sectors: [],
                            companies: [],
                            products: [],
                            sdgs: [`${sdg.sdg_id}: ${sdg.title}`].filter(Boolean),
                            use_cases: [app.application_name].filter(Boolean), // Application name as use case
                            fullDetails: {
                                type: 'SDG Application',
                                sdgId: sdg.sdg_id,
                                sdgTitle: sdg.title,
                                applicationName: app.application_name,
                                description: app.description,
                                relevantResearch: app.relevant_research,
                                relevantTechnologies: relevantResearchTech
                            }
                        });
                    });
                });
            }

            // Process Social Impact Data
            if (strategicDataCache.social && strategicDataCache.social.application_themes) {
                strategicDataCache.social.application_themes.forEach(theme => {
                    theme.applications.forEach(app => {
                        const relevantResearchTech = extractTechnologiesLocal(app.relevant_research);

                        searchableData.push({
                            id: `market-item-${idCounter++}`,
                            title: `${theme.theme_name} - ${app.title}`,
                            summary: app.application_description,
                            type: 'Social Impact Application',
                            technologies: relevantResearchTech,
                            sectors: [],
                            companies: [],
                            products: [],
                            sdgs: [],
                            use_cases: [app.title].filter(Boolean), // Application title as use case
                            fullDetails: {
                                type: 'Social Impact Application',
                                themeName: theme.theme_name,
                                applicationTitle: app.title,
                                description: app.application_description,
                                relevantResearch: app.relevant_research,
                                relevantTechnologies: relevantResearchTech
                            }
                        });
                    });
                });
            }

            // Process Learning Management Data
            if (strategicDataCache.lm && strategicDataCache.lm.micro_sectors) {
                strategicDataCache.lm.micro_sectors.forEach(microSector => {
                    const pubTech = extractTechnologiesLocal(microSector.research?.publications?.join(', ') || '');
                    const patentTech = extractTechnologiesLocal(microSector.research?.patents?.join(', ') || '');
                    const allTech = [...new Set([...pubTech, ...patentTech])];

                    searchableData.push({
                        id: `market-item-${idCounter++}`,
                        title: microSector.title,
                        summary: microSector.micro_sector_overview,
                        type: 'Learning Management Micro-Sector',
                        technologies: allTech,
                        sectors: ['Learning Management'],
                        companies: [],
                        products: [microSector.product_concept?.name].filter(Boolean),
                        sdgs: [],
                        use_cases: [microSector.product_concept?.problem].filter(Boolean),
                        fullDetails: {
                            type: 'Learning Management Micro-Sector',
                            microSectorTitle: microSector.title,
                            overview: microSector.micro_sector_overview,
                            productConceptName: microSector.product_concept?.name,
                            problem: microSector.product_concept?.problem,
                            coreTechnologies: microSector.product_concept?.core_technologies,
                            publications: microSector.research?.publications,
                            patents: microSector.research?.patents,
                            relevantTechnologies: allTech
                        }
                    });
                });
            }

            console.log("Market View Searchable Data loaded:", searchableData.length, "items");
            console.log("Sample Market View Searchable Data:", searchableData.slice(0, 5)); // Log a few samples
        }


        // --- Navigation and Page Rendering ---
        function showPage(pageId, filterParams = {}) {
            document.querySelectorAll('.page-content').forEach(page => {
                page.style.display = 'none';
            });
            // Fix for "Uncaught TypeError: Cannot read properties of null (reading 'style')"
            // Ensure the element exists before trying to access its style property
            const targetPage = document.getElementById(pageId + '-page');
            if (targetPage) {
                targetPage.style.display = 'block';
                // Scroll to top of the specific page content area
                targetPage.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                console.error(`Page element with ID '${pageId}-page' not found.`);
                return; // Exit if page not found to prevent further errors
            }

            document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
                link.classList.remove('active');
                link.removeAttribute('aria-current');
            });
            const activeLink = document.querySelector(`.navbar-nav .nav-link[onclick*="showPage('${pageId}')"]`);
            if(activeLink){
                activeLink.classList.add('active');
                activeLink.setAttribute('aria-current', 'page');
            }


            // Re-render content when page is shown
            if (pageId === 'dashboard') {
                // Activate the correct tab
                const tabTrigger = new bootstrap.Tab(document.getElementById(`${filterParams.view || 'technology'}-tab`));
                tabTrigger.show();
                showDashboardView(filterParams.view || 'technology'); // Default to Technology Portfolio View, or specified view
            } else if (pageId === 'patents') {
                renderPatentsPage();
            } else if (pageId === 'publications') {
                renderPublicationsPage();
            } else if (pageId === 'categories-insights') {
                // Pass the array of terms directly
                renderCategoriesInsights(filterParams.categories || []);
            } else if (pageId === 'strategic-insights') {
                // When strategic-insights is clicked, ensure the first heatmap is rendered and active
                const firstStrategicLink = document.querySelector('#strategic-nav a');
                if (firstStrategicLink) {
                    // Pass the element itself to renderStrategicHeatmap to handle active class
                    renderStrategicHeatmap(firstStrategicLink.getAttribute('onclick').match(/'([^']+)'/)[1], firstStrategicLink);
                }
            }
        }

        // --- Dashboard Page Rendering ---
        function renderDashboard() {
            // The integrated about section is now part of the dashboard page HTML directly.
            // We just need to ensure the correct dashboard view is shown and populated.
            showDashboardView('technology'); // Default to Technology Portfolio View
        }

        function showDashboardView(viewType) {
            // No need to manually hide/show tab panes, Bootstrap handles it.
            // Just ensure the content is rendered for the active tab.
            if (viewType === 'technology') {
                renderTechnologyPortfolioView();
            } else if (viewType === 'market') {
                renderMarketView();
            } else {
                console.error(`Invalid viewType: ${viewType}`);
            }
        }

        function renderTechnologyPortfolioView() {
            const techPortfolioView = document.getElementById('technology-portfolio-view');
            techPortfolioView.innerHTML = `
                <!--
                <div class="row mb-3">
                    <div class="col-12">
                        <button class="btn btn-outline-primary mb-3" onclick="showPage('dashboard')">
                            ← Back to Dashboard
                        </button>
                    </div>
                </div>
                -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Technology Cloud</h5>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" placeholder="Search technologies (e.g., AI, ML, NLP)" id="techCloudSearchInput" onkeyup="filterCloud('technologyCloud', this.value)">
                                    <button class="btn btn-primary" onclick="applyCloudFilter('technologyCloud')">Filter</button>
                                </div>
                                <div id="technologyCloud" class="cloud-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="card-title text-center text-primary">Technology & Readiness Insights</h5>
                        <br>
                        <div class="row" id="technologyDashboardTiles">
                            <!-- Technology Trend, Technology Readiness, Market Potential and Market Activity single tiles will be rendered here -->
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3 mt-5">
                    <h3 class="mb-0 text-primary">Patent Preview</h3>
                    <button class="btn btn-outline-primary" onclick="showPage('patents')">View Total: <span id="totalPatentsCount"></span> Patents</button>
                </div>
                <div class="table-responsive mb-5">
                    <table class="table table-hover dashboard-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Inventors</th>
                                <th>Tech Trend</th>
                                <th>Market Potential</th>
                                <th>Market Activity</th>
                                <th>TRL</th>
                                <th>Use Case Glimpse</th>
                            </tr>
                        </thead>
                        <tbody id="topPatentsTableBody"></tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3 mt-5">
                    <h3 class="mb-0 text-primary">Publications Preview</h3>
                    <button class="btn btn-outline-primary" onclick="showPage('publications')">View Total: <span id="totalPublicationsCount"></span> Publications</button>
                </div>
                <div class="table-responsive mb-5">
                    <table class="table table-hover dashboard-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Authors</th>
                                <th>Tech Trend</th>
                                <th>Market Potential</th>
                                <th>Market Activity</th>
                                <th>TRL</th>
                                <th>Use Case Glimpse</th>
                            </tr>
                        </thead>
                        <tbody id="topPublicationsTableBody"></tbody>
                    </table>
                </div>
            `;
            populateTechnologyCloud();
            renderTechnologyDashboardTiles(); // Render all four metrics here
            renderTop10Lists(); // This function already handles Patents and Publications
            document.getElementById('totalPatentsCount').textContent = allPatents.length;
            document.getElementById('totalPublicationsCount').textContent = allPublications.length;
        }

        function renderMarketView() {
            const marketView = document.getElementById('market-view');
            marketView.innerHTML = `
                <!--
                <div class="row mb-3">
                    <div class="col-12">
                        <button class="btn btn-outline-primary mb-3" onclick="showPage('dashboard')">
                            ← Back to Dashboard
                        </button>
                    </div>
                </div>
                -->
                <!--
                <div class="market-view-search-bar-section">
                    <h1>Explore Market Insights [Under Testing]</h1>
                    <div class="input-group market-view-search-input-group">
                        <input type="text" class="form-control market-view-search-input" placeholder="Search by keyword..." id="marketViewSearchInput" aria-label="Search input with dropdown button">
                        <button class="btn dropdown-toggle market-view-search-dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="marketViewSearchClassificationBtn">Classification: All</button>
                        <ul class="dropdown-menu dropdown-menu-end market-view-search-dropdown-menu">
                            <li><a class="dropdown-item market-view-search-classification-item" href="#" data-classification="all">All</a></li>
                            <li><a class="dropdown-item market-view-search-classification-item" href="#" data-classification="technology">Technology</a></li>
                            <li><a class="dropdown-item market-view-search-classification-item" href="#" data-classification="problem">Problem</a></li>
                            <li><a class="dropdown-item market-view-search-classification-item" href="#" data-classification="usecase">Use Case</a></li>
                            <li><a class="dropdown-item market-view-search-classification-item" href="#" data-classification="industry">Industry</a></li>
                            <li><a class="dropdown-item market-view-search-classification-item" href="#" data-classification="company">Company</a></li>
                            <li><a class="dropdown-item market-view-search-classification-item" href="#" data-classification="product">Product</a></li>
                            <li><a class="dropdown-item market-view-search-classification-item" href="#" data-classification="sdg">SDG</a></li>
                            <li><a class="dropdown-item market-view-search-classification-item" href="#" data-classification="social">Social Impact</a></li>
                        </ul>
                        <div id="marketViewSearchResultsSuggestions" class="market-view-search-suggestions d-none"></div>
                    </div>
                </div>
                -->
                <div id="marketViewSearchResultsContainer" class="content-section d-none">
                    <h3 class="search-results-title" id="marketViewResultsClassificationTitle">Search Results</h3>
                    <div id="marketViewSearchResultsDisplay" class="row">
                        <!-- Search results cards will be populated here -->
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Use Case Cloud</h5>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" placeholder="Explore use cases (e.g., healthcare, finance)" id="useCaseCloudSearchInput" onkeyup="filterCloud('useCaseWordCloud', this.value)">
                                    <button class="btn btn-primary" onclick="applyCloudFilter('useCaseWordCloud')">Filter</button>
                                </div>
                                <div id="useCaseWordCloud" class="cloud-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- New Market View Tiles -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="card-title text-center text-primary">Market View Insights</h5>
                        <br>
                        <div class="row" id="marketApplicationTiles">
                            <!-- SDG, Government/Social, Company, Product, Industry, Cross-Cutting tiles will be rendered here -->
                        </div>
                    </div>
                </div>
                <!-- Strategic Heatmaps Section - REMOVED from Market View -->
            `;
            populateUseCaseWordCloud();
            renderMarketApplicationTiles(); // Render the new application tiles
            setupMarketViewSearch(); // Setup search functionality for market view
        }

        // Removed toggleCloud function as buttons are removed and clouds are fixed size.
        // function toggleCloud(cloudId) { ... }

        // Modified filterCloud to handle multiple keywords and toggle 'selected' class
        function filterCloud(cloudId, searchTerm) {
            const cloudContainer = document.getElementById(cloudId);
            const tags = cloudContainer.querySelectorAll('.tag-cloud-item');
            
            // Split search term by comma or space, filter out empty strings, and convert to lowercase
            const keywords = searchTerm.toLowerCase().split(/[\s,]+/).filter(keyword => keyword.length > 0);

            tags.forEach(tag => {
                const tagText = tag.textContent.toLowerCase();
                let isVisible = false;

                if (keywords.length === 0) {
                    isVisible = true; // Show all if no search term
                } else {
                    // Check if tag text contains ANY of the keywords
                    isVisible = keywords.some(keyword => tagText.includes(keyword));
                }

                if (isVisible) {
                    tag.style.display = 'inline-block'; // Show if matches
                } else {
                    tag.style.display = 'none'; // Hide if no match
                }
            });
        }

        // New function to handle clicking on a cloud item (toggle selection and update search bar)
        function toggleCloudItemSelection(element, inputId) {
            element.classList.toggle('selected');
            const inputField = document.getElementById(inputId);
            let currentTerms = inputField.value.split(',').map(t => t.trim()).filter(t => t !== '');

            const term = element.textContent;
            if (element.classList.contains('selected')) {
                if (!currentTerms.includes(term)) {
                    currentTerms.push(term);
                }
            } else {
                currentTerms = currentTerms.filter(t => t !== term);
            }
            inputField.value = currentTerms.join(', ');
        }

        // New function to apply filters based on selected cloud items
        function applyCloudFilter(cloudId) {
            const inputId = cloudId === 'technologyCloud' ? 'techCloudSearchInput' : 'useCaseCloudSearchInput';
            const inputField = document.getElementById(inputId);
            const selectedTerms = inputField.value.split(',').map(t => t.trim()).filter(t => t !== '');

            // Navigate to categories-insights page with selected terms
            showPage('categories-insights', { categories: selectedTerms });
        }

        function populateTechnologyCloud() {
            const techFrequency = {};
            allPatents.forEach(p => {
                if (p.technologies_used) {
                    p.technologies_used.split(',').map(t => t.trim()).forEach(tech => {
                        techFrequency[tech] = (techFrequency[tech] || 0) + 1;
                    });
                }
            });
            allPublications.forEach(pub => {
                if (pub['Technologies Used']) {
                    pub['Technologies Used'].split(',').map(t => t.trim()).forEach(tech => {
                        techFrequency[tech] = (techFrequency[tech] || 0) + 1;
                    });
                }
            });
            const sortedTechs = Object.entries(techFrequency).sort(([, a], [, b]) => b - a); // Get all, not just top 20 initially
            const technologyCloudDiv = document.getElementById('technologyCloud');
            technologyCloudDiv.innerHTML = '';
            sortedTechs.forEach(([tech]) => {
                const span = document.createElement('span');
                span.className = 'tag-cloud-item';
                span.textContent = tech;
                span.style.borderColor = getBadgeColorClass(tech);
                span.style.color = getBadgeColorClass(tech);
                // Modified onclick to toggle selection and update search bar
                span.onclick = () => toggleCloudItemSelection(span, 'techCloudSearchInput');
                technologyCloudDiv.appendChild(span);
            });
        }

        function populateUseCaseWordCloud() {
            const useCaseFrequency = {};
            allPatents.forEach(p => {
                if (p.use_case_mapping) {
                    p.use_case_mapping.forEach(uc => {
                        useCaseFrequency[uc.use_case] = (useCaseFrequency[uc.use_case] || 0) + 1;
                    });
                }
            });
            allPublications.forEach(pub => {
                if (pub.Use_Cases) {
                    for (const extent in pub.Use_Cases) {
                        pub.Use_Cases[extent].forEach(uc => {
                            const cleanedUc = uc.split(':')[0].trim(); // Take only the main use case part
                            useCaseFrequency[cleanedUc] = (useCaseFrequency[cleanedUc] || 0) + 1;
                        });
                    }
                }
            });
            const sortedUseCases = Object.entries(useCaseFrequency).sort(([, a], [, b]) => b - a); // Get all
            const useCaseWordCloudDiv = document.getElementById('useCaseWordCloud');
            useCaseWordCloudDiv.innerHTML = '';
            sortedUseCases.forEach(([uc]) => {
                const span = document.createElement('span');
                span.className = 'tag-cloud-item';
                span.textContent = uc;
                span.style.borderColor = getBadgeColorClass(uc);
                span.style.color = getBadgeColorClass(uc);
                // Modified onclick to toggle selection and update search bar
                span.onclick = () => toggleCloudItemSelection(span, 'useCaseCloudSearchInput');
                useCaseWordCloudDiv.appendChild(span);
            });
        }

        // Render Technology Trend, Technology Readiness, Market Potential and Market Activity as single tiles for Technology Portfolio View
        function renderTechnologyDashboardTiles() {
            const technologyDashboardTiles = document.getElementById('technologyDashboardTiles');
            technologyDashboardTiles.innerHTML = ''; // Clear previous content

            // Aggregate data for patents and publications
            const techTrends = {};
            const techReadiness = {};
            const marketPotential = {};
            const marketActivity = {};

            allPatents.forEach(p => {
                if (p.technology_trends_summary) techTrends[p.technology_trends_summary] = (techTrends[p.technology_trends_summary] || 0) + 1;
                if (p.technology_readiness) techReadiness[p.technology_readiness] = (techReadiness[p.technology_readiness] || 0) + 1;
                if (p.market_potential_summary) marketPotential[p.market_potential_summary] = (marketPotential[p.market_potential_summary] || 0) + 1;
                if (p.market_activity) marketActivity[p.market_activity] = (marketActivity[p.market_activity] || 0) + 1;
            });

            allPublications.forEach(pub => {
                if (pub['Technology Trends Classification']) techTrends[pub['Technology Trends Classification']] = (techTrends[pub['Technology Trends Classification']] || 0) + 1;
                if (pub['Technology Readiness Key Applications']) techReadiness[pub['Technology Readiness Key Applications']] = (techReadiness[pub['Technology Readiness Key Applications']] || 0) + 1;
                if (pub['Market Potential Category']) marketPotential[pub['Market Potential Category']] = (marketPotential[pub['Market Potential Category']] || 0) + 1;
                if (pub['Market Activity Category']) marketActivity[pub['Market Activity Category']] = (marketActivity[pub['Market Activity Category']] || 0) + 1;
            });

            // Function to process and limit categories to top 2 + "Others"
            const processCategories = (data, topN = 2) => {
                const sortedEntries = Object.entries(data).sort(([, a], [, b]) => b - a);
                let processed = {};
                let othersCount = 0;

                if (sortedEntries.length > topN) {
                    for (let i = 0; i < topN; i++) {
                        processed[sortedEntries[i][0]] = sortedEntries[i][1];
                    }
                    for (let i = topN; i < sortedEntries.length; i++) {
                        othersCount += sortedEntries[i][1];
                    }
                    if (othersCount > 0) {
                        processed['Others'] = othersCount;
                    }
                } else {
                    processed = data; // If 2 or fewer categories, use them as is
                }
                return processed;
            };

            const limitedTechTrends = processCategories(techTrends);
            const limitedTechReadiness = processCategories(techReadiness);
            const limitedMarketPotential = processCategories(marketPotential);
            const limitedMarketActivity = processCategories(marketActivity);


            const summaryData = [
                { title: 'Technology Trends', data: limitedTechTrends, icon: 'fas fa-chart-line' },
                { title: 'Technology Readiness', data: limitedTechReadiness, icon: 'fas fa-flask' },
                { title: 'Market Potential', data: limitedMarketPotential, icon: 'fas fa-dollar-sign' },
                { title: 'Market Activity', data: limitedMarketActivity, icon: 'fas fa-chart-bar' }
            ];

            summaryData.forEach(category => {
                let listItems = '';
                let total = 0;
                for (const key in category.data) {
                    total += category.data[key];
                }

                for (const key in category.data) {
                    const count = category.data[key];
                    const percentage = total > 0 ? ((count / total) * 100).toFixed(0) : 0;
                    listItems += `<li><strong>${key}:</strong> <span>${count} <span class="percentage">(${percentage}%)</span></span></li>`;
                }
                technologyDashboardTiles.innerHTML += `
                    <div class="col-lg-6 col-md-6 col-sm-12"> <!-- Adjusted column classes for larger tiles -->
                        <div class="single-metric-tile">
                            <h5><i class="${category.icon}"></i>${category.title}</h5>
                            <ul>
                                ${listItems}
                            </ul>
                        </div>
                    </div>
                `;
            });
        }

        // Removed renderMarketMetricsTiles() as per request.
        /*
        function renderMarketMetricsTiles() {
            const marketMetricsTiles = document.getElementById('marketMetricsTiles');
            marketMetricsTiles.innerHTML = ''; // Clear previous content

            // Aggregate data for patents and publications
            const marketPotential = {};
            const marketActivity = {};

            allPatents.forEach(p => {
                if (p.market_potential_summary) marketPotential[p.market_potential_summary] = (marketPotential[p.market_potential_summary] || 0) + 1;
                if (p.market_activity) marketActivity[p.market_activity] = (marketActivity[p.market_activity] || 0) + 1;
            });

            allPublications.forEach(pub => {
                if (pub['Market Potential Category']) marketPotential[pub['Market Potential Category']] = (marketPotential[pub['Market Potential Category']] || 0) + 1;
                if (pub['Market Activity Category']) marketActivity[pub['Market Activity Category']] = (marketActivity[pub['Market Activity Category']] || 0) + 1;
            });

            const summaryData = [
                { title: 'Market Potential', data: marketPotential, icon: 'fas fa-hand-holding-usd' },
                { title: 'Market Activity', data: marketActivity, icon: 'fas fa-fire' }
            ];

            summaryData.forEach(category => {
                let listItems = '';
                for (const key in category.data) {
                    listItems += `<li><strong>${key}:</strong> <span>${category.data[key]}</span></li>`;
                }
                marketMetricsTiles.innerHTML += `
                    <div class="col-lg-6 col-md-6 col-sm-12">
                        <div class="single-metric-tile">
                            <h5><i class="${category.icon}"></i>${category.title}</h5>
                            <ul>
                                ${listItems}
                            </ul>
                        </div>
                    </div>
                `;
            });
        }
        */

        // Render the new Market Application Tiles as cards with "View Full Report" buttons
        function renderMarketApplicationTiles() {
            const marketApplicationTiles = document.getElementById('marketApplicationTiles');
            marketApplicationTiles.innerHTML = ''; // Clear previous content

            const tileConfigs = [
                {
                    title: '🌍 SDG',
                    dataKey: 'sdg',
                    countField: 'sustainable_development_goals',
                    summaryText: (data) => {
                        const count = data?.sustainable_development_goals?.length || 0;
                        const totalApplications = data?.sustainable_development_goals?.reduce((sum, sdg) => sum + (sdg.applications?.length || 0), 0) || 0;
                        return `Our technologies contribute to <strong>${count} global goals</strong> with <strong>${totalApplications}+ applications</strong>. Explore specific contributions to health, education, and sustainable cities.`;
                    },
                    detailPageType: 'sdg',
                },
                {
                    title: '🏛 Government Tech Impact',
                    dataKey: 'social',
                    countField: 'application_themes',
                    summaryText: (data) => {
                        const count = data?.application_themes?.length || 0;
                        const totalApplications = data?.application_themes?.reduce((sum, theme) => sum + (theme.applications?.length || 0), 0) || 0;
                        return `Discover <strong>${totalApplications}+ public use cases</strong> across <strong>${count} key themes</strong>, including public health, accessibility, and governance.`;
                    },
                    detailPageType: 'social',
                },
                {
                    title: '🏢 Company',
                    dataKey: 'company',
                    countField: 'companies',
                    summaryText: (data) => {
                        const count = data?.companies?.length || 0;
                        return `See how <strong>${count} leading companies</strong> leverage IIIT-H tech in strategic AI domains. View their core problems and our aligned research.`;
                    },
                    detailPageType: 'company',
                },
                {
                    title: '📦 Product',
                    dataKey: 'productwise',
                    countFunction: (data) => {
                        let count = 0;
                        for (const key in data) {
                            if (Array.isArray(data[key])) {
                                count += data[key].length;
                            }
                        }
                        return count;
                    },
                    summaryText: (data, itemCount) => `Explore <strong>${itemCount}+ consumer and industrial products</strong> embedding IIIT-H IP. See key use-cases and core technologies.`,
                    detailPageType: 'productwise',
                },
                {
                    title: '🏭 Industry',
                    dataKey: 'industry',
                    countField: 'industry_sectors',
                    summaryText: (data) => {
                        const count = data?.industry_sectors?.length || 0;
                        return `Gain insights across <strong>${count} diverse industrial sectors</strong>, from robotics to FinTech, and understand technology opportunities.`;
                    },
                    detailPageType: 'industry',
                }
                //{
                //    title: '🎓 Learning Management', // New tile for Learning Management
                //    dataKey: 'lm',
                //    countField: 'themes', // Assuming 'themes' array in LM data
                //    summaryText: (data) => {
                //        const count = data?.themes?.length || 0;
                //        const totalApplications = data?.themes?.reduce((sum, theme) => sum + (theme.applications?.length || 0), 0) || 0;
                //        return ` Discover AI-powered tutoring, robotic skill acquisition, and enterprise knowledge systems.`;
                //    },
                //    detailPageType: 'lm',
                //}
            ];

            tileConfigs.forEach(config => {
                let itemCount = 0;
                let description = '';

                if (config.dataKey && strategicDataCache[config.dataKey]) {
                    const data = strategicDataCache[config.dataKey];
                    if (config.countFunction) {
                        itemCount = config.countFunction(data);
                    } else if (data[config.countField] && Array.isArray(data[config.countField])) {
                        itemCount = data[config.countField].length;
                    }
                    description = config.summaryText(data, itemCount); // Pass data and itemCount to summaryText function
                } else {
                    description = `No data available for ${config.title}.`;
                }

                const onClickAction = config.detailPageType ? `showStrategicDetailPage('${config.detailPageType}', 'market')` : `alert('Details for ${config.title} not yet implemented.')`;

                marketApplicationTiles.innerHTML += `
                    <div class="col-lg-4 col-md-6 mb-4"> <!-- Adjusted column classes for larger tiles -->
                        <div class="card h-100">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${config.title}</h5>
                                <p class="card-text text-muted flex-grow-1">${description}</p>
                                <div class="mt-auto d-flex justify-content-between align-items-center">
                                    <button class="btn btn-primary btn-sm" onclick="${onClickAction}">View Full Report</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }


        function renderTop10Lists() {
            const topPatentsTableBody = document.getElementById('topPatentsTableBody');
            const topPublicationsTableBody = document.getElementById('topPublicationsTableBody');

            // Sort patents by a metric if available, otherwise just take first 10
            const sortedPatents = [...allPatents].sort((a, b) => (b.market_potential_summary === 'High Potential' ? 1 : 0) - (a.market_potential_summary === 'High Potential' ? 1 : 0)); // Example sort
            const top10Patents = sortedPatents.slice(0, 10);

            // Filter out 'Study' and 'Survey' type publications before sorting and slicing
            const filteredPublications = allPublications.filter(pub => pub['Type of Publication'] !== 'Study' && pub['Type of Publication'] !== 'Survey' );
            const sortedPublications = [...filteredPublications].sort((a, b) => (b['Market Potential Category'] === 'High Potential' ? 1 : 0) - (a['Market Potential Category'] === 'High Potential' ? 1 : 0)); // Example sort
            const top10Publications = sortedPublications.slice(0, 10);

            // Removed `topPatentsCount` and `topPublicationsCount` as they are now part of the "View Total" button

            topPatentsTableBody.innerHTML = top10Patents.map(patent => {
                const techTrend = patent.technology_trends_summary || 'N/A';
                const marketPotential = patent.market_potential_summary || 'N/A';
                const marketActivity = patent.market_activity || 'N/A';
                const trl = patent.technology_readiness || 'N/A';
                const useCaseText = patent.use_case_mapping && patent.use_case_mapping.length > 0 ? patent.use_case_mapping[0].use_case.split(' ').slice(0, 2).join(' ') : 'N/A';

                return `
                    <tr onclick="showPatentDetail(${patent.id})">
                        <td>${patent.title}</td>
                        <td>${patent.inventors || 'N/A'}</td>
                        <td><span class="badge" style="border-color: ${getBadgeColorClass(techTrend)}; color: ${getBadgeColorClass(techTrend)};">${techTrend}</span></td>
                        <td><span class="badge" style="border-color: ${getBadgeColorClass(marketPotential)}; color: ${getBadgeColorClass(marketPotential)};">${marketPotential}</span></td>
                        <td><span class="badge" style="border-color: ${getBadgeColorClass(marketActivity)}; color: ${getBadgeColorClass(marketActivity)};">${marketActivity}</span></td>
                        <td><span class="badge" style="border-color: ${getBadgeColorClass(trl)}; color: ${getBadgeColorClass(trl)};">${trl}</span></td>
                        <td><span class="badge" style="border-color: ${getBadgeColorClass(useCaseText)}; color: ${getBadgeColorClass(useCaseText)};">${useCaseText}</span></td>
                    </tr>
                `;
            }).join('');

            topPublicationsTableBody.innerHTML = top10Publications.map(pub => {
                const techTrend = pub['Technology Trends Classification'] || 'N/A';
                const marketPotential = pub['Market Potential Category'] || 'N/A';
                const marketActivity = pub['Market Activity Category'] || 'N/A';
                const trl = pub['Technology Readiness Key Applications'] || 'N/A';
                const useCaseText = extractUseCase(pub.Use_Cases);

                return `
                    <tr onclick="showPublicationDetail(${pub['S. No.']})">
                        <td>${pub.Title || pub['Title of the Publication']}</td>
                        <td>${pub.Authors || 'N/A'}</td>
                        <td><span class="badge" style="border-color: ${getBadgeColorClass(techTrend)}; color: ${getBadgeColorClass(techTrend)};">${techTrend}</span></td>
                        <td><span class="badge" style="border-color: ${getBadgeColorClass(marketPotential)}; color: ${getBadgeColorClass(marketPotential)};">${marketPotential}</span></td>
                        <td><span class="badge" style="border-color: ${getBadgeColorClass(marketActivity)}; color: ${getBadgeColorClass(marketActivity)};">${marketActivity}</span></td>
                        <td><span class="badge" style="border-color: ${getBadgeColorClass(trl)}; color: ${getBadgeColorClass(trl)};">${trl}</span></td>
                        <td><span class="badge" style="border-color: ${getBadgeColorClass(useCaseText)}; color: ${getBadgeColorClass(useCaseText)};">${useCaseText}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // --- Patents Page Rendering ---
        function renderPatentsPage(filteredPatents = allPatents) { // Default to allPatents on initial render
            const patentsPage = document.getElementById('patents-page');
            patentsPage.innerHTML = `
                <div class="row mb-3">
                    <div class="col-12">
                        <button class="btn btn-outline-primary mb-3" onclick="showPage('dashboard')">
                            ← Back to Dashboard
                        </button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="filter-sidebar">
                            <h5 class="filter-title">Filters</h5>
                            <!-- New Author/Inventor Filter -->
                            <div class="mb-3">
                                <label for="patentInventorFilter" class="form-label">Inventor</label>
                                <input type="text" id="patentInventorFilter" class="form-control" placeholder="Search by inventor name" onkeyup="applyPatentFilters()">
                            </div>
                            <!-- Existing dropdown filters -->
                            <div class="mb-3">
                                <label for="patentTechTrendFilter" class="form-label">Tech Trend</label>
                                <select id="patentTechTrendFilter" class="form-select" onchange="applyPatentFilters()">
                                    <option value="">All</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="patentReadinessFilter" class="form-label">Readiness</label>
                                <select id="patentReadinessFilter" class="form-select" onchange="applyPatentFilters()">
                                    <option value="">All</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="patentMarketPotentialFilter" class="form-label">Market Potential</label>
                                <select id="patentMarketPotentialFilter" class="form-select" onchange="applyPatentFilters()">
                                    <option value="">All</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="patentInnovationFilter" class="form-label">Innovation Level</label>
                                <select id="patentInnovationFilter" class="form-select" onchange="applyPatentFilters()">
                                    <option value="">All</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="patentDepthFilter" class="form-label">Depth of Tech</label>
                                <select id="patentDepthFilter" class="form-select" onchange="applyPatentFilters()">
                                    <option value="">All</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="patentMarketCategoryFilter" class="form-label">Market Category</label>
                                <select id="patentMarketCategoryFilter" class="form-select" onchange="applyPatentFilters()">
                                    <option value="">All</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="patentUseCaseExtentFilter" class="form-label">Use Case Extent</label>
                                <select id="patentUseCaseExtentFilter" class="form-select" onchange="applyPatentFilters()">
                                    <option value="">All</option>
                                    <option value="Complete">Complete</option>
                                    <option value="Partial">Partial</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                            <!-- New checkbox filters -->
                            <div class="mb-3 filter-dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="patentUseCaseCheckboxDropdown" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                                    Filter by Use Cases
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="patentUseCaseCheckboxDropdown" id="patentUseCaseCheckboxList" onchange="applyPatentFilters()">
                                    <!-- Use Cases will be loaded here -->
                                </ul>
                            </div>
                            <div class="mb-3 filter-dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="patentTechnologyCheckboxDropdown" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                                    Filter by Technologies
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="patentTechnologyCheckboxDropdown" id="patentTechnologyCheckboxList" onchange="applyPatentFilters()">
                                    <!-- Technologies will be loaded here -->
                                </ul>
                            </div>
                            <button class="btn btn-primary w-100 mb-2" onclick="applyPatentFilters()">Apply Filters</button>
                            <button class="btn btn-outline-secondary w-100" onclick="clearPatentFilters()">Clear Filters</button>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <h3 class="mb-3 text-primary">Patents Explorer (<span id="patentCount">0</span>)</h3>
                        <div id="patentsList" class="row row-cols-1 g-4">
                            <!-- Patents will be loaded here -->
                        </div>
                    </div>
                </div>
            `;
            populatePatentFilters(); // Populates existing select filters
            populatePatentCheckboxFilters(); // Populates new checkbox filters
            // Pass allPatents initially, then apply filters
            applyPatentFilters(); // Apply filters immediately after rendering the page to show initial filtered state
        }

        function populatePatentFilters() {
            const filters = {
                'patentTechTrendFilter': 'technology_trends_summary',
                'patentReadinessFilter': 'technology_readiness',
                'patentMarketPotentialFilter': 'market_potential_summary',
                'patentInnovationFilter': 'innovation_level_summary',
                'patentDepthFilter': 'depth_of_technology_summary',
                'patentMarketCategoryFilter': 'market_opportunity.category'
            };

            for (const [selectId, fieldName] of Object.entries(filters)) {
                const selectElement = document.getElementById(selectId);
                if (!selectElement) continue;
                selectElement.innerHTML = '<option value="">All</option>';
                const values = new Set();
                allPatents.forEach(item => {
                    let value = item;
                    fieldName.split('.').forEach(key => {
                        if (value && value[key] !== undefined) {
                            value = value[key];
                        } else {
                            value = undefined;
                        }
                    });
                    if (value) values.add(value);
                });
                Array.from(values).sort().forEach(val => {
                    const option = document.createElement('option');
                    option.value = val;
                    option.textContent = val;
                    selectElement.appendChild(option);
                });
            }
        }

        function populatePatentCheckboxFilters() {
            const useCaseSet = new Set();
            const technologySet = new Set();

            allPatents.forEach(p => {
                if (p.use_case_mapping) {
                    p.use_case_mapping.forEach(uc => useCaseSet.add(uc.use_case.split(' ').slice(0, 2).join(' ')));
                }
                if (p.technologies_used) {
                    p.technologies_used.split(',').map(t => t.trim()).forEach(tech => technologySet.add(tech));
                }
            });

            const useCaseCheckboxList = document.getElementById('patentUseCaseCheckboxList');
            useCaseCheckboxList.innerHTML = Array.from(useCaseSet).sort().map(uc => `
                <li>
                    <div class="form-check dropdown-item">
                        <input class="form-check-input" type="checkbox" value="${uc}" id="patentUseCaseCheckbox_${uc.replace(/\s/g, '_')}" onchange="applyPatentFilters()">
                        <label class="form-check-label" for="patentUseCaseCheckbox_${uc.replace(/\s/g, '_')}">
                            ${uc}
                        </label>
                    </div>
                </li>
            `).join('');

            const technologyCheckboxList = document.getElementById('patentTechnologyCheckboxList');
            technologyCheckboxList.innerHTML = Array.from(technologySet).sort().map(tech => `
                <li>

                    <div class="form-check dropdown-item">
                        <input class="form-check-input" type="checkbox" value="${tech}" id="patentTechCheckbox_${tech.replace(/\s/g, '_')}" onchange="applyPatentFilters()">
                        <label class="form-check-label" for="patentTechCheckbox_${tech.replace(/\s/g, '_')}">
                            ${tech}
                        </label>
                    </div>
                </li>
            `).join('');
        }

        function applyPatentFilters() {
            // Get values from existing select filters
            const techTrend = document.getElementById('patentTechTrendFilter').value;
            const readiness = document.getElementById('patentReadinessFilter').value;
            const marketPotential = document.getElementById('patentMarketPotentialFilter').value;
            const innovation = document.getElementById('patentInnovationFilter').value;
            const depth = document.getElementById('patentDepthFilter').value;
            const marketCategory = document.getElementById('patentMarketCategoryFilter').value;
            const useCaseExtent = document.getElementById('patentUseCaseExtentFilter').value;

            // Get value from new inventor filter
            const inventorSearchTerm = document.getElementById('patentInventorFilter').value.toLowerCase();

            // Get values from new checkbox filters
            const selectedUseCaseCheckboxes = Array.from(document.querySelectorAll('#patentUseCaseCheckboxList input:checked')).map(cb => cb.value);
            const selectedTechnologyCheckboxes = Array.from(document.querySelectorAll('#patentTechnologyCheckboxList input:checked')).map(cb => cb.value);

            const globalSearchTerm = document.getElementById('globalSearchInput').value.toLowerCase();

            let filtered = allPatents.filter(patent => {
                const matchesSelectFilters = (techTrend === '' || patent.technology_trends_summary === techTrend) &&
                                             (readiness === '' || patent.technology_readiness === readiness) &&
                                             (marketPotential === '' || patent.market_potential_summary === marketPotential) &&
                                             (innovation === '' || patent.innovation_level_summary === innovation) &&
                                             (depth === '' || patent.depth_of_technology_summary === depth) &&
                                             (marketCategory === '' || (patent.market_opportunity && patent.market_opportunity.category === marketCategory)) &&
                                             (useCaseExtent === '' || (patent.use_case_mapping && patent.use_case_mapping.some(uc => uc.extent_addressed === useCaseExtent)));

                const matchesCheckboxUseCases = selectedUseCaseCheckboxes.length === 0 ||
                                                (patent.use_case_mapping && patent.use_case_mapping.some(uc => selectedUseCaseCheckboxes.includes(uc.use_case.split(' ').slice(0, 2).join(' '))));

                const matchesCheckboxTechnologies = selectedTechnologyCheckboxes.length === 0 ||
                                                    (patent.technologies_used && patent.technologies_used.split(',').map(t => t.trim()).some(tech => selectedTechnologyCheckboxes.includes(t)));

                const matchesInventor = inventorSearchTerm === '' || (patent.inventors && patent.inventors.toLowerCase().includes(inventorSearchTerm));

                const matchesSearch = globalSearchTerm === '' ||
                                      (patent.title && patent.title.toLowerCase().includes(globalSearchTerm)) ||
                                      (patent.summary && patent.summary.toLowerCase().includes(globalSearchTerm)) ||
                                      (patent.inventors && patent.inventors.toLowerCase().includes(globalSearchTerm)) ||
                                      (patent.technologies_used && patent.technologies_used.toLowerCase().includes(globalSearchTerm));
                
                return matchesSelectFilters && matchesCheckboxUseCases && matchesCheckboxTechnologies && matchesInventor && matchesSearch;
            });

            currentPatents = filtered; // Update currentPatents for display and export
            displayPatents(currentPatents);
        }

        function clearPatentFilters() {
            // Clear existing select filters
            document.getElementById('patentTechTrendFilter').value = '';
            document.getElementById('patentReadinessFilter').value = '';
            document.getElementById('patentMarketPotentialFilter').value = '';
            document.getElementById('patentInnovationFilter').value = '';
            document.getElementById('patentDepthFilter').value = '';
            document.getElementById('patentMarketCategoryFilter').value = '';
            document.getElementById('patentUseCaseExtentFilter').value = '';

            // Clear new inventor filter
            document.getElementById('patentInventorFilter').value = '';

            // Clear new checkbox filters
            document.querySelectorAll('#patentUseCaseCheckboxList input:checked').forEach(cb => cb.checked = false);
            document.querySelectorAll('#patentTechnologyCheckboxList input:checked').forEach(cb => cb.checked = false);

            currentPatents = [...allPatents];
            displayPatents(currentPatents);
        }

        function displayPatents(patentsToDisplay) {
            const patentsList = document.getElementById('patentsList');
            patentsList.innerHTML = patentsToDisplay.map(patent => {
                const technologies = patent.technologies_used ? patent.technologies_used.split(',').map(t => t.trim()).slice(0, 2) : []; // Limit to 2 technologies
                const techTags = technologies.map(tech => `<span class="badge" style="border-color: ${getBadgeColorClass(tech)}; color: ${getBadgeColorClass(tech)};">${tech}</span>`).join('');
                const useCaseText = patent.use_case_mapping && patent.use_case_mapping.length > 0 ? patent.use_case_mapping[0].use_case.split(' ').slice(0, 2).join(' ') : 'N/A';
                const techTrend = patent.technology_trends_summary || 'N/A';
                const marketPotential = patent.market_potential_summary || 'N/A';
                const marketActivity = patent.market_activity || 'N/A';
                const trl = patent.technology_readiness || 'N/A';

                // Increased abstract snippet length to 150 characters (approx 2-3 lines)
                const abstractGlimpse = patent.summary ? (patent.summary.length > 180 ? patent.summary.substring(0, 180) + '...' : patent.summary) : 'N/A'; // Increased to ~3 lines

                return `
                    <div class="col">
                        <div class="card h-100 list-tile-card">
                            <div class="card-body">
                                <h5 class="card-title">${patent.title}</h5>
                                <p class="card-text mb-1">Inventors: ${patent.inventors || 'N/A'}</p>
                                <div class="badge-group">
                                    <span class="badge" style="border-color: ${getBadgeColorClass(techTrend)}; color: ${getBadgeColorClass(techTrend)};">${techTrend}</span>
                                    <span class="badge" style="border-color: ${getBadgeColorClass(marketPotential)}; color: ${getBadgeColorClass(marketPotential)};">${marketPotential}</span>
                                    <span class="badge" style="border-color: ${getBadgeColorClass(marketActivity)}; color: ${getBadgeColorClass(marketActivity)};">${marketActivity}</span>
                                    <span class="badge" style="border-color: ${getBadgeColorClass(trl)}; color: ${getBadgeColorClass(trl)};">${trl}</span>
                                </div>
                                <p class="card-text mb-1">Abstract: ${abstractGlimpse}</p>
                                <p class="card-text mb-3">Use Case: <span class="badge" style="border-color: ${getBadgeColorClass(useCaseText)}; color: ${getBadgeColorClass(useCaseText)};">${useCaseText}</span></p>
                                <button class="btn btn-outline-primary btn-sm" onclick="showPatentDetail(${patent.id})">View Details</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('patentCount').textContent = patentsToDisplay.length;
        }

        // --- Publications Page Rendering ---
        function renderPublicationsPage(filteredPublications = currentPublications) {
            const publicationsPage = document.getElementById('publications-page');
            publicationsPage.innerHTML = `
                <div class="row mb-3">
                    <div class="col-12">
                        <button class="btn btn-outline-primary mb-3" onclick="showPage('dashboard')">
                            ← Back to Dashboard
                        </button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="filter-sidebar">
                            <h5 class="filter-title">Filters</h5>
                            <!-- New Author/Inventor Filter -->
                            <div class="mb-3">
                                <label for="pubAuthorFilter" class="form-label">Author</label>
                                <input type="text" id="pubAuthorFilter" class="form-control" placeholder="Search by author name" onkeyup="applyPublicationFilters()">
                            </div>
                            <!-- Existing dropdown filters -->
                            <div class="mb-3">
                                <label for="pubTechTrendFilter" class="form-label">Tech Trend</label>
                                <select id="pubTechTrendFilter" class="form-select" onchange="applyPublicationFilters()">
                                    <option value="">All</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="pubReadinessFilter" class="form-label">Readiness</label>
                                <select id="pubReadinessFilter" class="form-select" onchange="applyPublicationFilters()">
                                    <option value="">All</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="pubMarketPotentialFilter" class="form-label">Market Potential</label>
                                <select id="pubMarketPotentialFilter" class="form-select" onchange="applyPublicationFilters()">
                                    <option value="">All</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="pubDepthFilter" class="form-label">Depth</label>
                                <select id="pubDepthFilter" class="form-select" onchange="applyPublicationFilters()">
                                    <option value="">All</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="pubCategoryFilter" class="form-label">Category</label>
                                <select id="pubCategoryFilter" class="form-select" onchange="applyPublicationFilters()">
                                    <option value="">All</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="pubTypeFilter" class="form-label">Type of Publication</label>
                                <select id="pubTypeFilter" class="form-select" onchange="applyPublicationFilters()">
                                    <option value="">All</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="pubUseCaseExtentFilter" class="form-label">Use Case Extent</label>
                                <select id="pubUseCaseExtentFilter" class="form-select" onchange="applyPublicationFilters()">
                                    <option value="">All</option>
                                    <option value="Complete">Complete</option>
                                    <option value="Partial">Partial</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                            <!-- New checkbox filters -->
                            <div class="mb-3 filter-dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="pubUseCaseCheckboxDropdown" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                                    Filter by Use Cases
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="pubUseCaseCheckboxDropdown" id="pubUseCaseCheckboxList" onchange="applyPublicationFilters()">
                                    <!-- Use Cases will be loaded here -->
                                </ul>
                            </div>
                            <div class="mb-3 filter-dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="pubTechnologyCheckboxDropdown" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                                    Filter by Technologies
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="pubTechnologyCheckboxDropdown" id="pubTechnologyCheckboxList" onchange="applyPublicationFilters()">
                                    <!-- Technologies will be loaded here -->
                                </ul>
                            </div>
                            <button class="btn btn-primary w-100 mb-2" onclick="applyPublicationFilters()">Apply Filters</button>
                            <button class="btn btn-outline-secondary w-100" onclick="clearPublicationFilters()">Clear Filters</button>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <h3 class="mb-3 text-primary">Publications Explorer (<span id="publicationCount">0</span>)</h3>
                        <div id="publicationsList" class="row row-cols-1 g-4">
                            <!-- Publications will be loaded here -->
                        </div>
                    </div>
                </div>
            `;
            populatePublicationFilters(); // Populates existing select filters
            populatePublicationCheckboxFilters(); // Populates new checkbox filters
            displayPublications(filteredPublications);
        }

        function populatePublicationFilters() {
            const filters = {
                'pubTechTrendFilter': 'Technology Trends Classification',
                'pubReadinessFilter': 'Technology Readiness Key Applications',
                'pubMarketPotentialFilter': 'Market Potential Category',
                'pubDepthFilter': 'Depth',
                'pubCategoryFilter': 'Category',
                'pubTypeFilter': 'Type of Publication'
            };

            for (const [selectId, fieldName] of Object.entries(filters)) {
                const selectElement = document.getElementById(selectId);
                if (!selectElement) continue;
                selectElement.innerHTML = '<option value="">All</option>';
                const values = new Set();
                allPublications.forEach(item => {
                    if (item[fieldName]) values.add(item[fieldName]);
                });
                Array.from(values).sort().forEach(val => {
                    const option = document.createElement('option');
                    option.value = val;
                    option.textContent = val;
                    selectElement.appendChild(option);
                });
            }
        }

        function populatePublicationCheckboxFilters() {
            const useCaseSet = new Set();
            const technologySet = new Set();

            allPublications.forEach(pub => {
                if (pub.Use_Cases) {
                    ['Complete', 'Partial', 'Low'].forEach(type => {
                        if (pub.Use_Cases[type]) {
                            pub.Use_Cases[type].forEach(uc => {
                                useCaseSet.add(uc.split(':')[0].trim().split(' ').slice(0, 2).join(' '));
                            });
                        }
                    });
                }
                if (pub['Technologies Used']) {
                    pub['Technologies Used'].split(',').map(t => t.trim()).forEach(tech => technologySet.add(tech));
                }
            });

            const useCaseCheckboxList = document.getElementById('pubUseCaseCheckboxList');
            useCaseCheckboxList.innerHTML = Array.from(useCaseSet).sort().map(uc => `
                <li>
                    <div class="form-check dropdown-item">
                        <input class="form-check-input" type="checkbox" value="${uc}" id="pubUseCaseCheckbox_${uc.replace(/\s/g, '_')}" onchange="applyPublicationFilters()">
                        <label class="form-check-label" for="pubUseCaseCheckbox_${uc.replace(/\s/g, '_')}">
                            ${uc}
                        </label>
                    </div>
                </li>
            `).join('');

            const technologyCheckboxList = document.getElementById('pubTechnologyCheckboxList');
            technologyCheckboxList.innerHTML = Array.from(technologySet).sort().map(tech => `
                <li>
                    <div class="form-check dropdown-item">
                        <input class="form-check-input" type="checkbox" value="${tech}" id="pubTechCheckbox_${tech.replace(/\s/g, '_')}" onchange="applyPublicationFilters()">
                        <label class="form-check-label" for="pubTechCheckbox_${tech.replace(/\s/g, '_')}">
                            ${tech}
                        </label>
                    </div>
                </li>
            `).join('');
        }

        function applyPublicationFilters() {
            // Get values from existing select filters
            const techTrend = document.getElementById('pubTechTrendFilter').value;
            const readiness = document.getElementById('pubReadinessFilter').value;
            const marketPotential = document.getElementById('pubMarketPotentialFilter').value;
            const depth = document.getElementById('pubDepthFilter').value;
            const category = document.getElementById('pubCategoryFilter').value;
            const type = document.getElementById('pubTypeFilter').value;
            const useCaseExtent = document.getElementById('pubUseCaseExtentFilter').value;

            // Get value from new author filter
            const authorSearchTerm = document.getElementById('pubAuthorFilter').value.toLowerCase();

            // Get values from new checkbox filters
            const selectedUseCaseCheckboxes = Array.from(document.querySelectorAll('#pubUseCaseCheckboxList input:checked')).map(cb => cb.value);
            const selectedTechnologyCheckboxes = Array.from(document.querySelectorAll('#pubTechnologyCheckboxList input:checked')).map(cb => cb.value);

            const globalSearchTerm = document.getElementById('globalSearchInput').value.toLowerCase();

            let filtered = allPublications.filter(pub => {
                const matchesSelectFilters = (techTrend === '' || pub['Technology Trends Classification'] === techTrend) &&
                                             (readiness === '' || pub['Technology Readiness Key Applications'] === readiness) &&
                                             (marketPotential === '' || pub['Market Potential Category'] === marketPotential) &&
                                             (depth === '' || pub.Depth === depth) &&
                                             (category === '' || pub.Category === category) &&
                                             (type === '' || pub['Type of Publication'] === type) &&
                                             (useCaseExtent === '' || (pub.Use_Cases && (
                                                (useCaseExtent === 'Complete' && pub.Use_Cases.Complete?.length > 0) ||
                                                (useCaseExtent === 'Partial' && pub.Use_Cases.Partial?.length > 0) ||
                                                (useCaseExtent === 'Low' && pub.Use_Cases.Low?.length > 0)
                                             )));

                const matchesCheckboxUseCases = selectedUseCaseCheckboxes.length === 0 ||
                                                (pub.Use_Cases && ['Complete', 'Partial', 'Low'].some(ucType =>
                                                    pub.Use_Cases[ucType] && pub.Use_Cases[ucType].some(uc =>
                                                        selectedUseCaseCheckboxes.includes(uc.split(':')[0].trim().split(' ').slice(0, 2).join(' '))
                                                    )
                                                ));

                const matchesCheckboxTechnologies = selectedTechnologyCheckboxes.length === 0 ||
                                                    (pub['Technologies Used'] && pub['Technologies Used'].split(',').map(t => t.trim()).some(tech => selectedTechnologyCheckboxes.includes(tech)));

                const matchesAuthor = authorSearchTerm === '' || (pub.Authors && pub.Authors.toLowerCase().includes(authorSearchTerm));

                const matchesSearch = globalSearchTerm === '' ||
                                      (pub.Title && pub.Title.toLowerCase().includes(globalSearchTerm)) ||
                                      (pub['Title of the Publication'] && pub['Title of the Publication'].toLowerCase().includes(globalSearchTerm)) ||
                                      (pub.Summary && pub.Summary.toLowerCase().includes(globalSearchTerm)) ||
                                      (pub.Authors && pub.Authors.toLowerCase().includes(globalSearchTerm)) ||
                                      (pub['Technologies Used'] && pub['Technologies Used'].toLowerCase().includes(globalSearchTerm));
                
                return matchesSelectFilters && matchesCheckboxUseCases && matchesCheckboxTechnologies && matchesAuthor && matchesSearch;
            });

            currentPublications = filtered; // Update currentPublications for display and export
            displayPublications(currentPublications);
        }

        function clearPublicationFilters() {
            // Clear existing select filters
            document.getElementById('pubTechTrendFilter').value = '';
            document.getElementById('pubReadinessFilter').value = '';
            document.getElementById('pubMarketPotentialFilter').value = '';
            document.getElementById('pubDepthFilter').value = '';
            document.getElementById('pubCategoryFilter').value = '';
            document.getElementById('pubTypeFilter').value = '';
            document.getElementById('pubUseCaseExtentFilter').value = '';

            // Clear new author filter
            document.getElementById('pubAuthorFilter').value = '';

            // Clear new checkbox filters
            document.querySelectorAll('#pubUseCaseCheckboxList input:checked').forEach(cb => cb.checked = false);
            document.querySelectorAll('#pubTechnologyCheckboxList input:checked').forEach(cb => cb.checked = false);

            currentPublications = [...allPublications];
            displayPublications(currentPublications);
        }

        function displayPublications(publicationsToDisplay) {
            const publicationsList = document.getElementById('publicationsList');
            publicationsList.innerHTML = publicationsToDisplay.map(pub => {
                const technologies = pub['Technologies Used'] ? pub['Technologies Used'].split(',').map(t => t.trim()).slice(0, 2) : []; // Limit to 2 technologies
                const techTags = technologies.map(tech => `<span class="badge" style="border-color: ${getBadgeColorClass(tech)}; color: ${getBadgeColorClass(tech)};">${tech}</span>`).join('');
                const useCaseText = extractUseCase(pub.Use_Cases);
                const techTrend = pub['Technology Trends Classification'] || 'N/A';
                const marketPotential = pub['Market Potential Category'] || 'N/A';
                const marketActivity = pub['Market Activity Category'] || 'N/A';
                const trl = pub['Technology Readiness Key Applications'] || 'N/A';

                // Increased abstract snippet length to 150 characters (approx 2-3 lines)
                const abstractGlimpse = pub.Summary ? (pub.Summary.length > 180 ? pub.Summary.substring(0, 180) + '...' : pub.Summary) : 'N/A'; // Increased to ~3 lines

                return `
                    <div class="col">
                        <div class="card h-100 list-tile-card">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${pub.Title || pub['Title of the Publication']}</h5>
                                <p class="card-text mb-1">Authors: ${pub.Authors || 'N/A'}</p>
                                <div class="badge-group">
                                    <span class="badge" style="border-color: ${getBadgeColorClass(techTrend)}; color: ${getBadgeColorClass(techTrend)};">${techTrend}</span>
                                    <span class="badge" style="border-color: ${getBadgeColorClass(marketPotential)}; color: ${getBadgeColorClass(marketPotential)};">${marketPotential}</span>
                                    <span class="badge" style="border-color: ${getBadgeColorClass(marketActivity)}; color: ${getBadgeColorClass(marketActivity)};">${marketActivity}</span>
                                    <span class="badge" style="border-color: ${getBadgeColorClass(trl)}; color: ${getBadgeColorClass(trl)};">${trl}</span>
                                </div>
                                <p class="card-text mb-1">Abstract: ${abstractGlimpse}</p>
                                <p class="card-text mb-3">Use Case: <span class="badge" style="border-color: ${getBadgeColorClass(useCaseText)}; color: ${getBadgeColorClass(useCaseText)};">${useCaseText}</span></p>
                                <button class="btn btn-outline-primary btn-sm" onclick="showPublicationDetail(${pub['S. No.']})">View Details</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('publicationCount').textContent = publicationsToDisplay.length;
        }

        // --- Detail View Functions ---
        function showPatentDetail(id) {
            const patent = allPatents.find(p => p.id === id);
            if (!patent) return;

            // Close global search results modal if open
            const globalSearchModalElement = document.getElementById('globalSearchResultsModal');
            const globalSearchModal = bootstrap.Modal.getInstance(globalSearchModalElement);
            if (globalSearchModal) {
                globalSearchModal.hide();
            }

            document.getElementById('patentDetailTitle').textContent = patent.title || 'N/A';
            document.getElementById('patentDetailInventors').textContent = patent.inventors || 'N/A';

            // Badges at the top
            document.getElementById('patentDetailTechTrendBadge').innerHTML = patent.technology_trends_summary ? `<span class="badge" style="border-color: ${getBadgeColorClass(patent.technology_trends_summary)}; color: ${getBadgeColorClass(patent.technology_trends_summary)};">${patent.technology_trends_summary}</span>` : '';
            document.getElementById('patentDetailMarketPotentialBadge').innerHTML = patent.market_potential_summary ? `<span class="badge" style="border-color: ${getBadgeColorClass(patent.market_potential_summary)}; color: ${getBadgeColorClass(patent.market_potential_summary)};">${patent.market_potential_summary}</span>` : '';
            document.getElementById('patentDetailMarketActivityBadge').innerHTML = patent.market_activity ? `<span class="badge" style="border-color: ${getBadgeColorClass(patent.market_activity)}; color: ${getBadgeColorClass(patent.market_activity)};">${patent.market_activity}</span>` : '';
            document.getElementById('patentDetailTRLBadge').innerHTML = patent.technology_readiness ? `<span class="badge" style="border-color: ${getBadgeColorClass(patent.technology_readiness)}; color: ${getBadgeColorClass(patent.technology_readiness)};">${patent.technology_readiness}</span>` : '';

            // Removed Abstract Glimpse and Use Case Glimpse
            // document.getElementById('patentDetailAbstractGlimpse').textContent = patent.summary ? (patent.summary.length > 150 ? patent.summary.substring(0, 150) + '...' : patent.summary) : 'N/A';
            // document.getElementById('patentDetailUseCaseGlimpse').textContent = patent.use_case_mapping && patent.use_case_mapping.length > 0 ? patent.use_case_mapping[0].use_case.split(' ').slice(0, 5).join(' ') + '...' : 'N/A'; // Glimpse of use case

            document.getElementById('patentDetailSummary').textContent = patent.summary || 'N/A';
            document.getElementById('patentDetailMarketCat').textContent = patent.market_opportunity?.category || 'N/A';
            document.getElementById('patentDetailMarketTrend').textContent = patent.market_trend || 'N/A';
            document.getElementById('patentDetailMarketPotentialSummary').textContent = patent.market_potential_summary || 'N/A';
            document.getElementById('patentDetailMarketActivity').textContent = patent.market_activity || 'N/A';

            document.getElementById('patentDetailProblem').textContent = patent.technology_assessment?.technical_problem || 'N/A';
            document.getElementById('patentDetailUniqueness').textContent = patent.technology_assessment?.uniqueness || 'N/A';
            document.getElementById('patentDetailApproach').textContent = patent.technology_assessment?.approach || 'N/A';
            document.getElementById('patentDetailTechTrend').textContent = patent.technology_assessment?.tech_trend || 'N/A';
            document.getElementById('patentDetailInnovationLevelSummary').textContent = patent.innovation_level_summary || 'N/A';
            document.getElementById('patentDetailDepthOfTechnologySummary').textContent = patent.depth_of_technology_summary || 'N/A';
            document.getElementById('patentDetailDetailedReasoning').textContent = patent.detailed_reasoning || 'N/A';

            const useCasesMappingDiv = document.getElementById('patentDetailUseCasesMapping');
            useCasesMappingDiv.innerHTML = '';
            if (patent.use_case_mapping && patent.use_case_mapping.length > 0) {
                patent.use_case_mapping.forEach(uc => {
                    useCasesMappingDiv.innerHTML += `<p><strong>${uc.use_case}:</strong> ${uc.description} (Extent Addressed: ${uc.extent_addressed})</p>`;
                });
            } else {
                useCasesMappingDiv.innerHTML = '<p>N/A</p>';
            }

            document.getElementById('patentDetailShortcomings').textContent = patent.shortcomings_risks?.shortcomings || 'N/A';
            document.getElementById('patentDetailRisks').textContent = patent.shortcomings_risks?.risks || 'N/A';

            const patentModal = new bootstrap.Modal(document.getElementById('patentDetailModal'));
            patentModal.show();
        }

        function showPublicationDetail(sNo) {
            const publication = allPublications.find(pub => pub['S. No.'] === sNo);
            if (!publication) return;

            // Close global search results modal if open
            const globalSearchModalElement = document.getElementById('globalSearchResultsModal');
            const globalSearchModal = bootstrap.Modal.getInstance(globalSearchModalElement);
            if (globalSearchModal) {
                globalSearchModal.hide();
            }

            document.getElementById('publicationDetailTitle').textContent = publication.Title || publication['Title of the Publication'] || 'N/A';
            document.getElementById('publicationDetailAuthors').textContent = publication.Authors || 'N/A';

            // Badges at the top
            document.getElementById('publicationDetailTechTrendBadge').innerHTML = publication['Technology Trends Classification'] ? `<span class="badge" style="border-color: ${getBadgeColorClass(publication['Technology Trends Classification'])}; color: ${getBadgeColorClass(publication['Technology Trends Classification'])};">${publication['Technology Trends Classification']}</span>` : '';
            document.getElementById('publicationDetailMarketPotentialBadge').innerHTML = publication['Market Potential Category'] ? `<span class="badge" style="border-color: ${getBadgeColorClass(publication['Market Potential Category'])}; color: ${getBadgeColorClass(publication['Market Potential Category'])};">${publication['Market Potential Category']}</span>` : '';
            document.getElementById('publicationDetailMarketActivityBadge').innerHTML = publication['Market Activity Category'] ? `<span class="badge" style="border-color: ${getBadgeColorClass(publication['Market Activity Category'])}; color: ${getBadgeColorClass(publication['Market Activity Category'])};">${publication['Market Activity Category']}</span>` : '';
            document.getElementById('publicationDetailTRLBadge').innerHTML = publication['Technology Readiness Key Applications'] ? `<span class="badge" style="border-color: ${getBadgeColorClass(publication['Technology Readiness Key Applications'])}; color: ${getBadgeColorClass(publication['Technology Readiness Key Applications'])};">${publication['Technology Readiness Key Applications']}</span>` : '';

            // Removed Abstract Glimpse and Use Case Glimpse
            // document.getElementById('publicationDetailAbstractGlimpse').textContent = publication.Summary ? (publication.Summary.length > 150 ? publication.Summary.substring(0, 150) + '...' : publication.Summary) : 'N/A';
            // document.getElementById('publicationDetailUseCaseGlimpse').textContent = extractUseCase(publication.Use_Cases) + '...'; // Glimpse of use case

            document.getElementById('publicationDetailSummary').textContent = publication.Summary || 'N/A';
            document.getElementById('publicationDetailMarketCat').textContent = publication.Category || 'N/A';
            document.getElementById('publicationDetailMarketTrend').textContent = publication.Market_Trend || 'N/A';
            document.getElementById('publicationDetailMarketPotentialType').textContent = publication['Market Potential Technology Type'] || 'N/A';
            document.getElementById('publicationDetailMarketPotentialCategory').textContent = publication['Market Potential Category'] || 'N/A';
            document.getElementById('publicationDetailMarketActivityCategory').textContent = publication['Market Activity Category'] || 'N/A';

            document.getElementById('publicationDetailProblem').textContent = publication.Technology?.Problem || 'N/A';
            document.getElementById('publicationDetailUniqueness').textContent = publication.Technology?.Uniqueness || 'N/A';
            document.getElementById('publicationDetailApproach').textContent = publication.Technology?.Approach || 'N/A';
            document.getElementById('publicationDetailTechTrend').textContent = publication.Technology?.['Tech Trend'] || 'N/A';
            document.getElementById('publicationDetailTechTrendClassification').textContent = publication['Technology Trends Classification'] || 'N/A';
            document.getElementById('publicationDetailDepth').textContent = publication.Depth || 'N/A';
            document.getElementById('publicationDetailDepthCategory').textContent = publication['Depth of Technology Category'] || 'N/A';

            const publicationUseCasesMappingDiv = document.getElementById('publicationDetailUseCasesMapping');
            publicationUseCasesMappingDiv.innerHTML = '';
            if (publication.Use_Cases) {
                for (const extent in publication.Use_Cases) {
                    if (publication.Use_Cases[extent].length > 0) {
                        publicationUseCasesMappingDiv.innerHTML += `<p><strong>${extent} Use Cases:</strong></p><ul>`;
                        publication.Use_Cases[extent].forEach(uc => {
                            publicationUseCasesMappingDiv.innerHTML += `<li>${uc}</li>`;
                        });
                        publicationUseCasesMappingDiv.innerHTML += `</ul>`;
                    }
                }
            } else {
                publicationUseCasesMappingDiv.innerHTML = '<p>N/A</p>';
            }

            document.getElementById('publicationDetailShortcomings').textContent = publication.Shortcomings_Risks?.Shortcomings || 'N/A';
            document.getElementById('publicationDetailRisks').textContent = publication.Shortcomings_Risks?.Risks || 'N/A';

            const publicationModal = new bootstrap.Modal(document.getElementById('publicationDetailModal'));
            publicationModal.show();
        }

        // --- Categories & Insights Page ---
        // Modified to accept an array of terms
        function renderCategoriesInsights(categoryTerms = []) {
            currentCategoryFilter = categoryTerms; // Store the current category filter (now an array)
            const categoriesInsightsPage = document.getElementById('categories-insights-page');
            categoriesInsightsPage.innerHTML = `
                <div class="row mb-3">
                    <div class="col-12">
                        <button class="btn btn-outline-primary mb-3" onclick="showPage('dashboard')">
                            ← Back to Dashboard
                        </button>
                    </div>
                </div>
                <div class="row pt-4">
                    <div class="col-md-3">
                        <div class="filter-sidebar">
                            <h5 class="filter-title">Filter Matched IP</h5>
                            <div id="categoryInsightsFilterOptions"></div>
                            <button class="btn btn-primary w-100 mb-2" onclick="applyCategoryInsightsFilters()">Apply Filters</button>
                            <button class="btn btn-outline-secondary w-100" onclick="clearCategoryInsightsFilters()">Clear Filters</button>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <h2 class="text-primary mb-4">Categories & Insights: <span id="currentCategoryTerm">${categoryTerms.join(', ') || 'All Categories'}</span></h2>
                        <div class="mb-3">
                            <label for="categoryDisplayFilter" class="form-label">Display</label>
                            <select id="categoryDisplayFilter" class="form-select" onchange="applyCategoryInsightsFilters()">
                                <option value="all">All (Patents & Publications)</option>
                                <option value="patents">Patents Only</option>
                                <option value="publications">Publications Only</option>
                            </select>
                        </div>
                        <div id="categoryInsightsContent"></div>
                    </div>
                </div>
            `;
            populateCategoryInsightsFilters();
            displayCategoryInsights(categoryTerms); // Pass the array
        }

        function populateCategoryInsightsFilters() {
            const filterSidebarOptions = document.getElementById('categoryInsightsFilterOptions');
            filterSidebarOptions.innerHTML = '';

            const filterFields = {
                'Type': 'type', // Custom filter for 'patent' or 'publication'
                'Technology Trends': 'technology_trends_summary', // This will be mapped for publications
                'Technology Readiness': 'technology_readiness', // This will be mapped for publications
                'Market Potential': 'market_potential_summary', // This will be mapped for publications
                'Market Activity': 'market_activity', // This will be mapped for publications
                'Depth of Technology': 'depth_of_technology_summary', // This will be mapped for publications
                'Innovation Level': 'innovation_level_summary' // This will be mapped for publications
            };

            for (const displayLabel in filterFields) {
                const fieldName = filterFields[displayLabel];
                let uniqueValues = [];

                if (fieldName === 'type') {
                    uniqueValues = ['patent', 'publication'];
                } else {
                    // Collect unique values from both patents and publications for the respective fields
                    const patentValues = allData
                        .filter(item => item.type === 'patent')
                        .map(p => {
                            let value = p;
                            fieldName.split('.').forEach(key => {
                                if (value && value[key] !== undefined) {
                                    value = value[key];
                                } else {
                                    value = undefined;
                                }
                            });
                            return value;
                        })
                        .filter(Boolean);

                    let publicationEquivalentField;
                    if (fieldName === 'technology_trends_summary') publicationEquivalentField = 'Technology Trends Classification';
                    else if (fieldName === 'technology_readiness') publicationEquivalentField = 'Technology Readiness Key Applications';
                    else if (fieldName === 'market_potential_summary') publicationEquivalentField = 'Market Potential Category';
                    else if (fieldName === 'market_activity') publicationEquivalentField = 'Market Activity Category';
                    else if (fieldName === 'depth_of_technology_summary') publicationEquivalentField = 'Depth of Technology Category';
                    else if (fieldName === 'innovation_level_summary') publicationEquivalentField = 'Depth';
                    // Add other mappings as needed

                    const publicationValues = allData
                        .filter(item => item.type === 'publication')
                        .map(pub => pub[publicationEquivalentField])
                        .filter(Boolean);

                    uniqueValues = [...new Set([...patentValues, ...publicationValues])];
                }
                uniqueValues.sort();

                let selectHtml = `
                    <div class="mb-3 filter-dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="categoryFilterDropdown-${fieldName}" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                            Filter by ${displayLabel}
                        </button>
                        <ul class="dropdown-menu p-3" aria-labelledby="categoryFilterDropdown-${fieldName}" style="max-height: 300px; overflow-y: auto;">
                `;
                uniqueValues.forEach(value => {
                    const isChecked = currentFilters.categories[fieldName] && currentFilters.categories[fieldName].includes(value) ? 'checked' : '';
                    selectHtml += `
                        <li>
                            <div class="form-check dropdown-item">
                                <input class="form-check-input category-insights-filter-checkbox" type="checkbox" value="${value}" id="categoryFilter_${fieldName}_${value.replace(/\s/g, '_').replace(/&/g, 'and')}" ${isChecked} data-field="${fieldName}" onchange="applyCategoryInsightsFilters()">
                                <label class="form-check-label" for="categoryFilter_${fieldName}_${value.replace(/\s/g, '_').replace(/&/g, 'and')}">
                                    ${value}
                                </label>
                            </div>
                        </li>
                    `;
                });
                selectHtml += `</ul></div>`;
                filterSidebarOptions.innerHTML += selectHtml;
            }
        }

        function applyCategoryInsightsFilters() {
            // Clear previous selections for checkbox filters
            currentFilters.categories = {};

            // Collect selected values from all checkbox filters
            document.querySelectorAll('.category-insights-filter-checkbox:checked').forEach(checkbox => {
                const field = checkbox.dataset.field;
                const value = checkbox.value;
                if (!currentFilters.categories[field]) {
                    currentFilters.categories[field] = [];
                }
                currentFilters.categories[field].push(value);
            });

            displayCategoryInsights(currentCategoryFilter);
        }

        function clearCategoryInsightsFilters() {
            currentFilters.categories = {}; // Clear all filters
            document.querySelectorAll('.category-insights-filter-checkbox').forEach(cb => {
                cb.checked = false; // Uncheck all checkboxes
            });
            document.getElementById('categoryDisplayFilter').value = 'all'; // Reset display filter
            currentCategoryFilter = []; // Clear the category terms
            document.getElementById('currentCategoryTerm').textContent = 'All Categories'; // Update display
            displayCategoryInsights(currentCategoryFilter); // Re-render with no filters
        }

        // Modified displayCategoryInsights to handle an array of terms and new filters
        function displayCategoryInsights(terms = []) {
            const contentDiv = document.getElementById('categoryInsightsContent');
            contentDiv.innerHTML = '';
            
            // Ensure terms is always an array
if (!Array.isArray(terms)) {
    terms = terms ? [terms] : [];
}
currentCategoryFilter = terms; // Store the current category filter (now an array)

const displayFilter = document.getElementById('categoryDisplayFilter').value;

let filteredItems = allData.filter(item => {
    // First, filter by the category terms (Technology or Use Case)
    let matchesCategoryTerm = false;
    if (terms.length === 0) { // If no specific terms are selected from cloud, show all
        matchesCategoryTerm = true;
    } else {
        const lowerCaseTerms = terms.map(t => t.toLowerCase());
        if (item.type === 'patent') {
            const patentTechnologies = item.technologies_used ? item.technologies_used.toLowerCase() : '';
            const patentUseCases = item.use_case_mapping ? item.use_case_mapping.map(uc => uc.use_case.toLowerCase()).join(',') : '';
            matchesCategoryTerm = lowerCaseTerms.some(term => patentTechnologies.includes(term) || patentUseCases.includes(term));
        } else if (item.type === 'publication') {
            const pubTechnologies = item['Technologies Used'] ? item['Technologies Used'].toLowerCase() : '';
            const pubUseCases = item.Use_Cases ? Object.values(item.Use_Cases).flat().map(uc => uc.toLowerCase()).join(',') : '';
            matchesCategoryTerm = lowerCaseTerms.some(term => pubTechnologies.includes(term) || pubUseCases.includes(term));
        }
    }
    
    if (!matchesCategoryTerm) return false;

    // Second, apply the additional filters from the sidebar
    for (const field in currentFilters.categories) {
        if (currentFilters.categories[field].length > 0) {
            const selectedValues = currentFilters.categories[field];
            let itemValue;

            if (item.type === 'patent') {
                if (field.includes('.')) {
                    let nestedValue = item;
                    field.split('.').forEach(key => {
                        if (nestedValue && nestedValue[key] !== undefined) {
                            nestedValue = nestedValue[key];
                        } else {
                            nestedValue = undefined;
                        }
                    });
                    itemValue = nestedValue;
                } else {
                    itemValue = item[field];
                }
            } else if (item.type === 'publication') {
                if (field === 'type') {
                    itemValue = 'publication';
                } else if (field === 'technology_trends_summary') {
                    itemValue = item['Technology Trends Classification'];
                } else if (field === 'technology_readiness') {
                    itemValue = item['Technology Readiness Key Applications'];
                } else if (field === 'market_potential_summary') {
                    itemValue = item['Market Potential Category'];
                } else if (field === 'market_activity') {
                    itemValue = item['Market Activity Category'];
                } else if (field === 'depth_of_technology_summary') {
                    itemValue = item['Depth of Technology Category'];
                } else if (field === 'innovation_level_summary') {
                    itemValue = item['Depth'];
                } else {
                    itemValue = item[field];
                }
            }
            
            // Check if the item's value for the current field is included in the selected values
            if (!selectedValues.includes(itemValue)) {
                return false;
            }
        }
    }
    return true;
});

let matchedPatents = filteredItems.filter(item => item.type === 'patent');
let matchedPublications = filteredItems.filter(item => item.type === 'publication');

document.getElementById('currentCategoryTerm').textContent = terms.join(', ') || 'All Categories';

if (displayFilter === 'patents') {
    matchedPublications = [];
} else if (displayFilter === 'publications') {
    matchedPatents = [];
}

contentDiv.innerHTML += `
    <h4 class="mt-4">Matched Patents (${matchedPatents.length})</h4>
    <div class="row row-cols-1 g-4" id="categoryPatentsGrid"></div>
    <h4 class="mt-4">Matched Publications (${matchedPublications.length})</h4>
    <div class="row row-cols-1 g-4" id="categoryPublicationsGrid"></div>
`;

const categoryPatentsGrid = document.getElementById('categoryPatentsGrid');
matchedPatents.forEach(patent => {
    const technologies = patent.technologies_used ? patent.technologies_used.split(',').map(t => t.trim()).slice(0, 3) : [];
    const summarySnippet = patent.summary ? (patent.summary.length > 180 ? patent.summary.substring(0, 180) + '...' : patent.summary) : 'N/A'; // ~3 lines
    const inventorsShort = patent.inventors ? (patent.inventors.split(',')[0] + (patent.inventors.includes(',') ? ' et al.' : '')) : 'N/A';

    categoryPatentsGrid.innerHTML += `
        <div class="col">
            <div class="card h-100 list-tile-card">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">${patent.title}</h5>
                    <p class="card-text text-muted">Inventors: ${inventorsShort}</p>
                    <div class="badge-group">
                        ${technologies.map((tech, index) => `<span class="badge" style="border-color: ${getBadgeColorClass(tech)}; color: ${getBadgeColorClass(tech)};">${tech}</span>`).join('')}
                    </div>
                    <p class="card-text flex-grow-1">${summarySnippet}</p>
                    <div class="mt-auto">
                        <button class="btn btn-sm btn-outline-primary rounded-pill mt-2" onclick="showPatentDetail(${patent.id})">View Full Details</button>
                    </div>
                </div>
            </div>
        </div>
    `;
});

const categoryPublicationsGrid = document.getElementById('categoryPublicationsGrid');
matchedPublications.forEach(publication => {
    const technologies = publication['Technologies Used'] ? publication['Technologies Used'].split(',').map(t => t.trim()).slice(0, 3) : [];
    const summarySnippet = publication.Summary ? (publication.Summary.length > 180 ? publication.Summary.substring(0, 180) + '...' : publication.Summary) : 'N/A'; // ~3 lines
    const authorsShort = publication.Authors ? (publication.Authors.split(',')[0] + (publication.Authors.includes(',') ? ' et al.' : '')) : 'N/A';

    categoryPublicationsGrid.innerHTML += `
        <div class="col">
            <div class="card h-100 list-tile-card">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">${publication.Title || publication['Title of the Publication']}</h5>
                    <p class="card-text text-muted">Authors: ${authorsShort}</p>
                    <div class="mb-2">
                        ${technologies.map((tech, index) => `<span class="badge" style="border-color: ${getBadgeColorClass(tech)}; color: ${getBadgeColorClass(tech)};">${tech}</span>`).join('')}
                    </div>
                    <p class="card-text flex-grow-1">${summarySnippet}</p>
                    <div class="mt-auto">
                        <button class="btn btn-sm btn-outline-primary rounded-pill mt-2" onclick="showPublicationDetail(${publication['S. No.']})">View Full Details</button>
                    </div>
                </div>
            </div>
        </div>
    `;
});
}

// --- Strategic Insights Page (Overview with Heatmaps) ---
function renderStrategicInsightsPage() {
    // The strategic-insights-page structure is now static in HTML.
    // We just need to ensure the first heatmap is rendered by default.
    const page = document.getElementById('strategic-insights-page');
    const firstStrategicLink = page.querySelector('#strategic-nav a');
    if (firstStrategicLink) {
        // Pass the element itself to renderStrategicHeatmap to handle active class
        renderStrategicHeatmap(firstStrategicLink.getAttribute('onclick').match(/'([^']+)'/)[1], firstStrategicLink);
    }
}

async function renderStrategicHeatmap(type, element) {
    // Handle active state for the sidebar navigation
    if (element) {
        const navLinks = document.querySelectorAll('#strategic-nav a');
        navLinks.forEach(link => link.classList.remove('active'));
        element.classList.add('active');
    }

    const strategicContentArea = document.getElementById('strategic-content-area');
    strategicContentArea.innerHTML = '<div class="text-center mt-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

    const config = heatmapConfigs.find(c => c.type === type);

    if (!config) {
        strategicContentArea.innerHTML = '<div class="alert alert-danger">Heatmap configuration not found for this type.</div>';
        return;
    }

    let summaryHtml = '';
    switch (type) {
        case 'productwise': summaryHtml = '<p class="lead">Explore the technological alignment and challenges for various products.</p>'; break;
        case 'sdg': summaryHtml = '<p class="lead">View how different technologies contribute to UN Sustainable Development Goals.</p>'; break;
        case 'social': summaryHtml = '<p class="lead">Discover the social impact and government applications of various technologies.</p>'; break;
        case 'industry': summaryHtml = '<p class="lead">Analyze technology and product opportunities across different industry sectors.</p>'; break;
        case 'company': summaryHtml = '<p class="lead">Examine the technology and research alignment of key companies.</p>'; break;
        case 'lm': summaryHtml = '<p class="lead">Explore technologies and product concepts for education, training, and knowledge management.</p>'; break; // Placeholder, will be replaced by specific LM summary
    }

    // Construct and display heatmap using the found config, passing 'strategic-insights' as origin
    const heatmapHtml = generateHeatmapTable(config, 'strategic-insights');

    strategicContentArea.innerHTML = `
        ${heatmapHtml}
        <div class="text-center my-4">
            ${summaryHtml}
            <button class="btn btn-primary mt-3" onclick="showStrategicDetailPage('${type}', 'strategic-insights')">View Full Report</button>
        </div>
    `;
    // Ensure scroll position is at the top of the heatmap container
    const heatmapContainer = strategicContentArea.querySelector('.heatmap-container');
    if (heatmapContainer) {
        heatmapContainer.scrollTop = 0;
    }
}

// Modified showStrategicDetailPage to accept originPage
function showStrategicDetailPage(type, originPage = 'strategic-insights') {
    const detailPageId = `${type}-detail-page`;
    const detailPageElement = document.getElementById(detailPageId);
    if (!detailPageElement) {
        console.error(`Detail page element with ID '${detailPageId}' not found.`);
        return;
    }

    let htmlContent = '';
    let fullDetails = null;

    switch(type) {
        case 'productwise':
            fullDetails = strategicDataCache.productwise;
            if (fullDetails) htmlContent = getProductwiseInsightsHtml(fullDetails, originPage);
            break;
        case 'sdg':
            fullDetails = strategicDataCache.sdg;
            if (fullDetails) htmlContent = getSdgInsightsHtml(fullDetails, originPage);
            break;
        case 'social':
            fullDetails = strategicDataCache.social;
            if (fullDetails) htmlContent = getSocialInsightsHtml(fullDetails, originPage);
            break;
        case 'industry':
            fullDetails = strategicDataCache.industry;
            if (fullDetails) htmlContent = getIndustryInsightsHtml(fullDetails, originPage);
            break;
        case 'company':
            fullDetails = strategicDataCache.company;
            if (fullDetails) htmlContent = getCompanyInsightsHtml(fullDetails, originPage);
            break;
        case 'lm':
            fullDetails = strategicDataCache.lm;
            if (fullDetails) htmlContent = getLearningManagementInsightsHtml(fullDetails, originPage);
            break;
        default:
            htmlContent = `<div class="alert alert-info" role="alert">Details not available for this type.</div>`;
    }

    if (fullDetails) {
        currentStrategicEntryDetail = { data: fullDetails, fileNamePrefix: type.replace(/\s/g, '_') + '_FullReport' };
    } else {
        currentStrategicEntryDetail = null;
    }

    detailPageElement.innerHTML = htmlContent;
    showPage(type + '-detail'); // Navigate to the full detail page
}

// Modified showStrategicEntryDetail to handle direct fullDetails object from market search
function showStrategicEntryDetailFromMarketSearch(fullDetails, type) { // Changed cloudItemKey to fullDetails directly
    if (!fullDetails) {
        console.error(`Full details not found for cloud item.`);
        return;
    }

    currentStrategicEntryDetail = { data: fullDetails, fileNamePrefix: type.replace(/\s/g, '_') + '_Details' };

    document.getElementById('strategicEntryDetailModalLabel').textContent = `${type} Details`;
    const modalBody = document.getElementById('strategicEntryDetailModalBody');
    modalBody.innerHTML = displayObjectProperties(fullDetails); // Use the helper to display all properties

    // Update the download button's onclick to use the currentStrategicEntryDetail
    document.getElementById('downloadStrategicEntryPdfBtn').onclick = () => downloadPDF('strategic-entry-detail');

    const strategicEntryModal = new bootstrap.Modal(document.getElementById('strategicEntryDetailModal'));
    strategicEntryModal.show();
}

// New function to show details for a heatmap row/column header
function showHeatmapHeaderDetail(type, header, headerType) {
    const config = heatmapConfigs.find(c => c.type === type);
    if (!config) {
        console.error(`Heatmap config not found for type: ${type}`);
        return;
    }

    let detailData = null;
    let title = `${headerType === 'row' ? 'Row' : 'Column'} Header: ${header}`;
    let description = '';
    let relevantItems = [];

    // Find the relevant data from strategicDataCache
    switch (type) {
        case 'industry':
            if (headerType === 'row') { // Industry Sector
                detailData = strategicDataCache.industry?.industry_sectors?.find(s => s.sector_name === header);
                description = detailData?.description || 'No description available.';
                relevantItems = detailData?.micro_sectors?.map(m => m.name) || [];
            } else { // Technology (Column)
                // For column headers (technologies), we don't have a direct detail object.
                // We can list all patents/publications that use this technology.
                description = `Technologies related to ${header}.`;
                relevantItems = allData.filter(item => {
                    const technologiesUsed = item.type === 'patent' ? item.technologies_used : item['Technologies Used'];
                    return technologiesUsed && technologiesUsed.toLowerCase().includes(header.toLowerCase());
                }).map(item => item.title || item.Title || item['Title of the Publication']);
            }
            break;
        case 'company':
            if (headerType === 'row') { // Company Name
                detailData = strategicDataCache.company?.companies?.find(c => c.name === header);
                description = detailData?.strategy || 'No strategy available.';
                relevantItems = detailData?.strategic_areas?.map(a => a.Area) || [];
            } else { // Technology (Column) - same as industry
                description = `Technologies related to ${header}.`;
                relevantItems = allData.filter(item => {
                    const technologiesUsed = item.type === 'patent' ? item.technologies_used : item['Technologies Used'];
                    return technologiesUsed && technologiesUsed.toLowerCase().includes(header.toLowerCase());
                }).map(item => item.title || item.Title || item['Title of the Publication']);
            }
            break;
        case 'productwise':
            if (headerType === 'row') { // Product Name
                // Products are nested under categories in productwise.json
                for (const category in strategicDataCache.productwise) {
                    detailData = strategicDataCache.productwise[category]?.find(p => p.product_name === header);
                    if (detailData) break;
                }
                description = detailData?.description || 'No description available.';
                relevantItems = detailData?.strategic_areas?.map(a => a.name) || [];
            } else { // Technology (Column) - same as industry
                description = `Technologies related to ${header}.`;
                relevantItems = allData.filter(item => {
                    const technologiesUsed = item.type === 'patent' ? item.technologies_used : item['Technologies Used'];
                    return technologiesUsed && technologiesUsed.toLowerCase().includes(header.toLowerCase());
                }).map(item => item.title || item.Title || item['Title of the Publication']);
            }
            break;
        case 'social':
            if (headerType === 'row') { // Social Impact Theme
                detailData = strategicDataCache.social?.application_themes?.find(t => t.theme_name === header);
                description = detailData?.theme_description || 'No description available.';
                relevantItems = detailData?.applications?.map(a => a.title) || [];
            } else { // Technology (Column) - same as industry
                description = `Technologies related to ${header}.`;
                relevantItems = allData.filter(item => {
                    const technologiesUsed = item.type === 'patent' ? item.technologies_used : item['Technologies Used'];
                    return technologiesUsed && technologiesUsed.toLowerCase().includes(header.toLowerCase());
                }).map(item => item.title || item.Title || item['Title of the Publication']);
            }
            break;
        case 'sdg':
            if (headerType === 'row') { // SDG Goal
                detailData = strategicDataCache.sdg?.sustainable_development_goals?.find(s => s.title === header);
                description = detailData?.description || 'No description available.';
                relevantItems = detailData?.applications?.map(a => a.application_name) || [];
            } else { // Technology (Column) - same as industry
                description = `Technologies related to ${header}.`;
                relevantItems = allData.filter(item => {
                    const technologiesUsed = item.type === 'patent' ? item.technologies_used : item['Technologies Used'];
                    return technologiesUsed && technologiesUsed.toLowerCase().includes(header.toLowerCase());
                }).map(item => item.title || item.Title || item['Title of the Publication']);
            }
            break;
        case 'lm': // Learning Management
            if (headerType === 'row') { // Micro-sector Title
                detailData = strategicDataCache.lm?.micro_sectors?.find(ms => ms.title === header);
                description = detailData?.micro_sector_overview || 'No overview available.';
                relevantItems = [detailData?.product_concept?.name].filter(Boolean) || [];
            } else { // Technology (Column) - same as other tech columns
                description = `Technologies related to ${header}.`;
                relevantItems = allData.filter(item => {
                    const technologiesUsed = item.type === 'patent' ? item.technologies_used : item['Technologies Used'];
                    return technologiesUsed && technologiesUsed.toLowerCase().includes(header.toLowerCase());
                }).map(item => item.title || item.Title || item['Title of the Publication']);
            }
            break;
    }

    let modalBodyHtml = `
        <h5>${title}</h5>
        <p>${description}</p>
    `;

    if (relevantItems.length > 0) {
        modalBodyHtml += `<h6>Relevant ${headerType === 'row' ? 'Sub-categories/Applications' : 'Patents/Publications'}:</h6><ul>`;
        relevantItems.forEach(item => {
            modalBodyHtml += `<li>${item}</li>`;
        });
        modalBodyHtml += `</ul>`;
    } else if (!detailData) {
         modalBodyHtml += `<p class="text-muted">No specific detailed data found for this header. Showing general information.</p>`;
    }

    // If a specific detailData object was found, display its properties
    if (detailData && typeof detailData === 'object') {
        modalBodyHtml += `<h6>Full Details:</h6>`;
        modalBodyHtml += displayObjectProperties(detailData);
    }

    document.getElementById('heatmapHeaderCellDetailModalLabel').textContent = `${config.title} - ${header}`;
    document.getElementById('heatmapHeaderCellDetailModalBody').innerHTML = modalBodyHtml;

    currentHeatmapHeaderCellDetail = { data: detailData || { type: 'header', headerType: headerType, header: header, relevantItems: relevantItems }, fileNamePrefix: `${type}_${headerType}_${header.replace(/\s/g, '_')}` };
    document.getElementById('downloadHeatmapHeaderCellPdfBtn').onclick = () => downloadPDF('heatmap-header-cell-detail');

    const modal = new bootstrap.Modal(document.getElementById('heatmapHeaderCellDetailModal'));
    modal.show();
}

// New function to show details for a specific heatmap cell (intersection)
// This function is no longer called from heatmap cells directly, but can be used if needed.
function showHeatmapCellDetail(type, rowHeader, colHeader, value) {
    const config = heatmapConfigs.find(c => c.type === type);
    if (!config) {
        console.error(`Heatmap config not found for type: ${type}`);
        return;
    }

    const papers = config.paperMapping?.[rowHeader]?.[colHeader] || [];
    currentDrilldownPapers = papers; // Store for CSV download

    let modalBodyHtml = `
        <h5>Intersection: ${rowHeader} x ${colHeader}</h5>
        <p>Value: ${value}</p>
        <h6>Relevant Research Papers:</h6>
    `;

    if (papers.length > 0) {
        modalBodyHtml += `<ul class="list-disc list-inside space-y-1">`;
        papers.forEach(paper => {
            modalBodyHtml += `<li>${paper}</li>`;
        });
        modalBodyHtml += `</ul>`;
    } else {
        modalBodyHtml += `<p>No relevant papers found for this intersection.</p>`;
    }

    document.getElementById('heatmapHeaderCellDetailModalLabel').textContent = `${config.title} - ${rowHeader} x ${colHeader}`;
    document.getElementById('heatmapHeaderCellDetailModalBody').innerHTML = modalBodyHtml;

    currentHeatmapHeaderCellDetail = { data: { type: 'cell', row: rowHeader, col: colHeader, value: value, papers: papers }, fileNamePrefix: `${type}_${rowHeader.replace(/\s/g, '_')}_${colHeader.replace(/\s/g, '_')}` };
    document.getElementById('downloadHeatmapHeaderCellPdfBtn').onclick = () => downloadPDF('heatmap-header-cell-detail');


    const modal = new bootstrap.Modal(document.getElementById('heatmapHeaderCellDetailModal'));
    modal.show();
}

// --- Heatmap Drilldown and PDF/CSV Export Functions ---
// showHeatmapDrilldown is now replaced by showHeatmapCellDetail for heatmap cell clicks.
// Keeping it here for reference if needed elsewhere, but it's not directly called from heatmaps anymore.
/*
function showHeatmapDrilldown(type, rowHeader, colHeader) {
    const config = heatmapConfigs.find(c => c.type === type);
    if (!config || !config.paperMapping || !config.paperMapping[rowHeader] || !config.paperMapping[rowHeader][colHeader]) {
        console.warn(`No papers found for ${type}: ${rowHeader} - ${colHeader}`);
        document.getElementById('heatmapDrilldownPaperList').innerHTML = '<li>No relevant papers found.</li>';
        document.getElementById('heatmapDetailCriteria').textContent = `${rowHeader} x ${colHeader}`;
        document.getElementById('heatmapDetailTitleSpan').textContent = config ? config.title : 'N/A';
        currentDrilldownPapers = []; // Clear for download
        const heatmapModal = new bootstrap.Modal(document.getElementById('heatmapDetailModal'));
        heatmapModal.show();
        return;
    }

    const papers = config.paperMapping[rowHeader][colHeader];
    currentDrilldownPapers = papers; // Store for CSV download

    const paperListHtml = papers.map(paper => `<li>${paper}</li>`).join('');
    document.getElementById('heatmapDrilldownPaperList').innerHTML = paperListHtml;
    document.getElementById('heatmapDetailCriteria').textContent = `${rowHeader} x ${colHeader}`;
    document.getElementById('heatmapDetailTitleSpan').textContent = config.title;

    const heatmapModal = new bootstrap.Modal(document.getElementById('heatmapDetailModal'));
    heatmapModal.show();
}
*/

function downloadHeatmapDrilldownAsCSV() {
    if (currentDrilldownPapers.length === 0) {
        alert('No papers to download.');
        return;
    }

    let csvContent = "data:text/csv;charset=utf-8,Paper Title\n";
    currentDrilldownPapers.forEach(paper => {
        csvContent += `"${paper.replace(/"/g, '""')}"\n`; // Handle commas and quotes
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "heatmap_drilldown_papers.csv");
    document.body.appendChild(link); // Required for Firefox
    link.click();
    document.body.removeChild(link);
}

function downloadPDF(type) {
    let element;
    let filename = 'document.pdf';
    let dataToPrint = {};

    if (type === 'patent') {
        element = document.getElementById('patentDetailModal').querySelector('.modal-body');
        filename = document.getElementById('patentDetailTitle').textContent.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '_PatentDetails.pdf';
        const patentId = allPatents.find(p => p.title === document.getElementById('patentDetailTitle').textContent)?.id;
        dataToPrint = allPatents.find(p => p.id === patentId);
    } else if (type === 'publication') {
        element = document.getElementById('publicationDetailModal').querySelector('.modal-body');
        filename = document.getElementById('publicationDetailTitle').textContent.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '_PublicationDetails.pdf';
        const pubTitle = document.getElementById('publicationDetailTitle').textContent;
        dataToPrint = allPublications.find(pub => pub.Title === pubTitle || pub['Title of the Publication'] === pubTitle);
    } else if (type === 'strategic-entry-detail') {
        if (!currentStrategicEntryDetail) {
            console.error("No strategic entry detail available for PDF download.");
            return;
        }
        element = document.getElementById('strategicEntryDetailModalBody');
        filename = `${currentStrategicEntryDetail.fileNamePrefix || 'Strategic_Entry'}_Details.pdf`;
        dataToPrint = currentStrategicEntryDetail.data;
    } else if (type === 'heatmap-header-cell-detail') {
         if (!currentHeatmapHeaderCellDetail) {
            console.error("No heatmap header/cell detail available for PDF download.");
            return;
        }
        element = document.getElementById('heatmapHeaderCellDetailModalBody'); // Corrected ID
        filename = `${currentHeatmapHeaderCellDetail.fileNamePrefix || 'Heatmap_Detail'}_Details.pdf`;
        dataToPrint = currentHeatmapHeaderCellDetail.data;
    }
    else { // For full strategic reports (productwise, sdg, social, industry, company, lm)
        // We need to re-generate the content for the PDF to ensure it's complete and styled correctly
        // as the page might not be visible or fully rendered when the PDF is requested.
        dataToPrint = strategicDataCache[type];
        if (!dataToPrint) {
            console.error(`Strategic data for type '${type}' not found for PDF export.`);
            return;
        }
        filename = `${type.replace(/\s/g, '_')}_FullReport.pdf`;
    }

    // Create a temporary div to render the content for PDF generation
    const tempDiv = document.createElement('div');
    tempDiv.style.padding = '20px';
    tempDiv.style.fontFamily = 'Poppins, sans-serif';
    tempDiv.style.fontSize = '12px';
    tempDiv.style.color = '#343a40';
    tempDiv.style.backgroundColor = 'white'; // Ensure background for PDF

    // Populate tempDiv based on type
    if (type === 'patent' || type === 'publication' || type === 'strategic-entry-detail' || type === 'heatmap-header-cell-detail') {
        tempDiv.innerHTML = element.innerHTML;
    } else { 
        // Regenerate content for full strategic reports
        switch(type) {
            case 'productwise':
                tempDiv.innerHTML = getProductwiseInsightsHtml(dataToPrint, 'pdf-export');
                break;
            case 'sdg':
                tempDiv.innerHTML = getSdgInsightsHtml(dataToPrint, 'pdf-export');
                break;
            case 'social':
                tempDiv.innerHTML = getSocialInsightsHtml(dataToPrint, 'pdf-export');
                break;
            case 'industry':
                tempDiv.innerHTML = getIndustryInsightsHtml(dataToPrint, 'pdf-export');
                break;
            case 'company':
                tempDiv.innerHTML = getCompanyInsightsHtml(dataToPrint, 'pdf-export');
                break;
            case 'lm':
                tempDiv.innerHTML = getLearningManagementInsightsHtml(dataToPrint, 'pdf-export');
                break;
            default:
                tempDiv.innerHTML = `<p>Error: Content for ${type} not found for PDF export.</p>`;
        }
    }

    // Append to body temporarily to ensure styles are applied
    document.body.appendChild(tempDiv);

    html2pdf(tempDiv, {
        margin: 10,
        filename: filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    }).then(() => {
        // Clean up the temporary div after PDF generation
        document.body.removeChild(tempDiv);
    }).catch(error => {
        console.error("Error generating PDF:", error);
        // Clean up the temporary div even if there's an error
        document.body.removeChild(tempDiv);
        alert("Failed to generate PDF. Please try again.");
    });
}

// --- Global Search Functionality ---
function handleGlobalSearch(event) {
    event.preventDefault();
    const searchTerm = document.getElementById('globalSearchInput').value.toLowerCase();
    if (!searchTerm) {
        alert('Please enter a search term.');
        return;
    }

    const searchResults = allData.filter(item => {
        const title = item.type === 'patent' ? item.title : (item.Title || item['Title of the Publication']);
        const summary = item.type === 'patent' ? item.summary : item.Summary;
        const authorsOrInventors = item.type === 'patent' ? item.inventors : item.Authors;
        const technologies = item.type === 'patent' ? item.technologies_used : item['Technologies Used'];

        return (title && title.toLowerCase().includes(searchTerm)) ||
               (summary && summary.toLowerCase().includes(searchTerm)) ||
               (authorsOrInventors && authorsOrInventors.toLowerCase().includes(searchTerm)) ||
               (technologies && technologies.toLowerCase().includes(searchTerm));
    });

    displayGlobalSearchResults(searchResults, searchTerm);
    const searchModal = new bootstrap.Modal(document.getElementById('globalSearchResultsModal'));
    searchModal.show();
}

function displayGlobalSearchResults(results, searchTerm) {
    const resultsContent = document.getElementById('globalSearchResultsContent');
    resultsContent.innerHTML = ''; // Clear previous results

    if (results.length === 0) {
        resultsContent.innerHTML = `<div class="col-12"><p class="text-center">No results found for "${searchTerm}".</p></div>`;
        return;
    }

    results.forEach(item => {
        const title = item.type === 'patent' ? item.title : (item.Title || item['Title of the Publication']);
        const authorsOrInventors = item.type === 'patent' ? item.inventors : item.Authors;
        const summarySnippet = item.type === 'patent' ? (item.summary ? (item.summary.length > 180 ? item.summary.substring(0, 180) + '...' : item.summary) : 'N/A') : (item.Summary ? (item.Summary.length > 180 ? item.Summary.substring(0, 180) + '...' : item.Summary) : 'N/A');
        
        let techTrend, marketPotential, marketActivity, trl, useCaseText;

        if (item.type === 'patent') {
            techTrend = item.technology_trends_summary || 'N/A';
            marketPotential = item.market_potential_summary || 'N/A';
            marketActivity = item.market_activity || 'N/A';
            trl = item.technology_readiness || 'N/A';
            useCaseText = item.use_case_mapping && item.use_case_mapping.length > 0 ? item.use_case_mapping[0].use_case.split(' ').slice(0, 2).join(' ') : 'N/A';
        } else { // publication
            techTrend = item['Technology Trends Classification'] || 'N/A';
            marketPotential = item['Market Potential Category'] || 'N/A';
            marketActivity = item['Market Activity Category'] || 'N/A';
            trl = item['Technology Readiness Key Applications'] || 'N/A';
            useCaseText = extractUseCase(item.Use_Cases);
        }

        const detailFunction = item.type === 'patent' ? `showPatentDetail(${item.id})` : `showPublicationDetail(${item['S. No.']})`;

        resultsContent.innerHTML += `
            <div class="col">
                <div class="card h-100 list-tile-card">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">${title}</h5>
                        <p class="card-text mb-1">${item.type === 'patent' ? 'Inventors' : 'Authors'}: ${authorsOrInventors || 'N/A'}</p>
                        <div class="badge-group">
                            <span class="badge" style="border-color: ${getBadgeColorClass(techTrend)}; color: ${getBadgeColorClass(techTrend)};">${techTrend}</span>
                            <span class="badge" style="border-color: ${getBadgeColorClass(marketPotential)}; color: ${getBadgeColorClass(marketPotential)};">${marketPotential}</span>
                            <span class="badge" style="border-color: ${getBadgeColorClass(marketActivity)}; color: ${getBadgeColorClass(marketActivity)};">${marketActivity}</span>
                            <span class="badge" style="border-color: ${getBadgeColorClass(trl)}; color: ${getBadgeColorClass(trl)};">${trl}</span>
                        </div>
                        <p class="card-text mb-1">Abstract: ${summarySnippet}</p>
                        <p class="card-text mb-3">Use Case: <span class="badge" style="border-color: ${getBadgeColorClass(useCaseText)}; color: ${getBadgeColorClass(useCaseText)};">${useCaseText}</span></p>
                        <div class="mt-auto">
                            <button class="btn btn-outline-primary btn-sm" onclick="${detailFunction}">View Details</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
}

// --- Market View Search Functionality ---
let currentMarketSearchClassification = 'all'; // Default classification

function setupMarketViewSearch() {
    const searchInput = document.getElementById('marketViewSearchInput');
    const searchSuggestions = document.getElementById('marketViewSearchResultsSuggestions');
    const classificationBtn = document.getElementById('marketViewSearchClassificationBtn');

    // Event listener for classification dropdown items
    document.querySelectorAll('.market-view-search-classification-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            currentMarketSearchClassification = this.dataset.classification;
            classificationBtn.textContent = `Classification: ${this.textContent}`;
            // Trigger search with new classification
            performMarketViewSearch(searchInput.value);
        });
    });

    // Event listener for search input (keyup for suggestions)
    searchInput.addEventListener('keyup', function() {
        const searchTerm = this.value;
        if (searchTerm.length > 2) {
            showMarketViewSearchSuggestions(searchTerm);
        } else {
            searchSuggestions.classList.add('d-none');
            document.getElementById('marketViewSearchResultsContainer').classList.add('d-none'); // Hide results when search term is too short
        }
    });

    // Event listener for clicking outside suggestions to hide them
    document.addEventListener('click', function(event) {
        if (!searchInput.contains(event.target) && !searchSuggestions.contains(event.target)) {
            searchSuggestions.classList.add('d-none');
        }
    });
}

function showMarketViewSearchSuggestions(searchTerm) {
    const searchSuggestions = document.getElementById('marketViewSearchResultsSuggestions');
    searchSuggestions.innerHTML = '';
    const lowerCaseSearchTerm = searchTerm.toLowerCase();

    const uniqueSuggestions = new Set();
    const MAX_SUGGESTIONS = 10;

    searchableData.forEach(item => {
        // Check title
        if (item.title && item.title.toLowerCase().includes(lowerCaseSearchTerm) && uniqueSuggestions.size < MAX_SUGGESTIONS) {
            uniqueSuggestions.add(item.title);
        }
        // Check summary
        if (item.summary && item.summary.toLowerCase().includes(lowerCaseSearchTerm) && uniqueSuggestions.size < MAX_SUGGESTIONS) {
            uniqueSuggestions.add(item.summary);
        }
        // Check technologies
        item.technologies.forEach(tech => {
            if (tech.toLowerCase().includes(lowerCaseSearchTerm) && uniqueSuggestions.size < MAX_SUGGESTIONS) {
                uniqueSuggestions.add(tech);
            }
        });
        // Check sectors
        item.sectors.forEach(sector => {
            if (sector.toLowerCase().includes(lowerCaseSearchTerm) && uniqueSuggestions.size < MAX_SUGGESTIONS) {
                uniqueSuggestions.add(sector);
            }
        });
        // Check companies
        item.companies.forEach(company => {
            if (company.toLowerCase().includes(lowerCaseSearchTerm) && uniqueSuggestions.size < MAX_SUGGESTIONS) {
                uniqueSuggestions.add(company);
            }
        });
        // Check products
        item.products.forEach(product => {
            if (product.toLowerCase().includes(lowerCaseSearchTerm) && uniqueSuggestions.size < MAX_SUGGESTIONS) {
                uniqueSuggestions.add(product);
            }
        });
        // Check SDGs
        item.sdgs.forEach(sdg => {
            if (sdg.toLowerCase().includes(lowerCaseSearchTerm) && uniqueSuggestions.size < MAX_SUGGESTIONS) {
                uniqueSuggestions.add(sdg);
            }
        });
        // Check use_cases
        item.use_cases.forEach(uc => {
            if (uc.toLowerCase().includes(lowerCaseSearchTerm) && uniqueSuggestions.size < MAX_SUGGESTIONS) {
                uniqueSuggestions.add(uc);
            }
        });
    });

    if (uniqueSuggestions.size > 0) {
        Array.from(uniqueSuggestions).slice(0, MAX_SUGGESTIONS).forEach(suggestion => {
            const div = document.createElement('div');
            div.className = 'market-view-search-suggestion-item';
            div.textContent = suggestion;
            div.onclick = () => {
                document.getElementById('marketViewSearchInput').value = suggestion;
                searchSuggestions.classList.add('d-none');
                performMarketViewSearch(suggestion);
            };
            searchSuggestions.appendChild(div);
        });
        searchSuggestions.classList.remove('d-none');
    } else {
        searchSuggestions.classList.add('d-none');
    }
}

function performMarketViewSearch(searchTerm) {
    const resultsDisplay = document.getElementById('marketViewSearchResultsDisplay');
    const resultsContainer = document.getElementById('marketViewSearchResultsContainer');
    const resultsTitle = document.getElementById('marketViewResultsClassificationTitle');
    resultsDisplay.innerHTML = '';
    resultsContainer.classList.remove('d-none'); // Show the results container

    const lowerCaseSearchTerm = searchTerm.toLowerCase();
    const filteredResults = searchableData.filter(item => {
        let matches = false;
        if (currentMarketSearchClassification === 'all' || currentMarketSearchClassification === 'technology') {
            matches = matches || item.technologies.some(tech => tech.toLowerCase().includes(lowerCaseSearchTerm));
        }
        if (currentMarketSearchClassification === 'all' || currentMarketSearchClassification === 'problem') {
            matches = matches || (item.summary && item.summary.toLowerCase().includes(lowerCaseSearchTerm));
        }
        if (currentMarketSearchClassification === 'all' || currentMarketSearchClassification === 'usecase') {
            matches = matches || item.use_cases.some(uc => uc.toLowerCase().includes(lowerCaseSearchTerm));
        }
        if (currentMarketSearchClassification === 'all' || currentMarketSearchClassification === 'industry') {
            matches = matches || item.sectors.some(sector => sector.toLowerCase().includes(lowerCaseSearchTerm));
        }
        if (currentMarketSearchClassification === 'all' || currentMarketSearchClassification === 'company') {
            matches = matches || item.companies.some(company => company.toLowerCase().includes(lowerCaseSearchTerm));
        }
        if (currentMarketSearchClassification === 'all' || currentMarketSearchClassification === 'product') {
            matches = matches || item.products.some(product => product.toLowerCase().includes(lowerCaseSearchTerm));
        }
        if (currentMarketSearchClassification === 'all' || currentMarketSearchClassification === 'sdg') {
            matches = matches || item.sdgs.some(sdg => sdg.toLowerCase().includes(lowerCaseSearchTerm));
        }
        if (currentMarketSearchClassification === 'all' || currentMarketSearchClassification === 'social') {
            // Social impact items are generally covered by title/summary matching
            matches = matches || (item.type === 'Social Impact Application' && (item.title.toLowerCase().includes(lowerCaseSearchTerm) || item.summary.toLowerCase().includes(lowerCaseSearchTerm)));
        }
        if (currentMarketSearchClassification === 'all' || currentMarketSearchClassification === 'lm') {
            matches = matches || (item.type === 'Learning Management Micro-Sector' && (item.title.toLowerCase().includes(lowerCaseSearchTerm) || item.summary.toLowerCase().includes(lowerCaseSearchTerm)));
        }

        // Always include title match for 'all' or if no specific classification matched yet
        if (currentMarketSearchClassification === 'all' && item.title && item.title.toLowerCase().includes(lowerCaseSearchTerm)) {
            matches = true;
        }

        return matches;
    });

    resultsTitle.textContent = `Search Results for "${searchTerm}" (${filteredResults.length} results)`;

    if (filteredResults.length === 0) {
        resultsDisplay.innerHTML = `<div class="col-12"><p class="text-center">No results found for "${searchTerm}" under "${currentMarketSearchClassification}" classification.</p></div>`;
        return;
    }

    filteredResults.forEach(item => {
        const technologiesDisplay = item.technologies.map(tech => `<span class="badge" style="border-color: ${getBadgeColorClass(tech)}; color: ${getBadgeColorClass(tech)};">${tech}</span>`).join(' ');
        const summarySnippet = item.summary ? (item.summary.length > 180 ? item.summary.substring(0, 180) + '...' : item.summary) : 'No summary available.';

        resultsDisplay.innerHTML += `
            <div class="col-lg-6 col-md-12 mb-4">
                <div class="card h-100 list-tile-card">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">${item.title}</h5>
                        <p class="card-text text-muted mb-1">Type: ${item.type}</p>
                        <div class="badge-group mb-2">
                            ${technologiesDisplay}
                        </div>
                        <p class="card-text flex-grow-1">${summarySnippet}</p>
                        <div class="mt-auto">
                            <button class="btn btn-outline-primary btn-sm" onclick="showStrategicEntryDetailFromMarketSearch(${JSON.stringify(item.fullDetails)}, '${item.type}')">View Full Details</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
}

// --- Market View Heatmap Rendering ---
async function renderMarketHeatmap(type, element) {
    // Handle active state for the sidebar navigation
    if (element) {
        const navLinks = document.querySelectorAll('#market-heatmap-nav a');
        navLinks.forEach(link => link.classList.remove('active'));
        element.classList.add('active');
    }

    const marketHeatmapsContentArea = document.getElementById('market-view-heatmaps-content-area');
    marketHeatmapsContentArea.innerHTML = '<div class="text-center mt-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

    const config = heatmapConfigs.find(c => c.type === type);

    if (!config) {
        marketHeatmapsContentArea.innerHTML = '<div class="alert alert-danger">Heatmap configuration not found for this type.</div>';
        return;
    }

    let summaryHtml = '';
    switch (type) {
        case 'productwise': summaryHtml = '<p class="lead">Explore the technological alignment and challenges for various products.</p>'; break;
        case 'sdg': summaryHtml = '<p class="lead">View how different technologies contribute to UN Sustainable Development Goals.</p>'; break;
        case 'social': summaryHtml = '<p class="lead">Discover the social impact and government applications of various technologies.</p>'; break;
        case 'industry': summaryHtml = '<p class="lead">Analyze technology and product opportunities across different industry sectors.</p>'; break;
        case 'company': summaryHtml = '<p class="lead">Examine the technology and research alignment of key companies.</p>'; break;
        case 'lm': summaryHtml = '<p class="lead">Explore technologies and product concepts for education, training, and knowledge management.</p>'; break;
    }

    // Construct and display heatmap using the found config, passing 'market' as origin
    const heatmapHtml = generateHeatmapTable(config, 'market');

    marketHeatmapsContentArea.innerHTML = `
        ${heatmapHtml}
        <div class="text-center my-4">
            ${summaryHtml}
            <button class="btn btn-primary mt-3" onclick="showStrategicDetailPage('${type}', 'market')">View Full Report</button>
        </div>
    `;
    // Ensure scroll position is at the top of the heatmap container
    const heatmapContainer = marketHeatmapsContentArea.querySelector('.heatmap-container');
    if (heatmapContainer) {
        heatmapContainer.scrollTop = 0;
    }
}


// Load data when the window loads
window.onload = loadData;
</script>
</body>
</html>